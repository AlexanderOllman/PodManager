{% extends "base.html" %}

{% block title %}HPE Private Cloud AI Resource Manager{% endblock %}

{% block content %}
<div class="tab-content" id="mainContent">
    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
            <h1 class="h2">Dashboard</h1>
        </div>

        <!-- Dashboard Cards/Tiles -->
        <div class="dashboard-cards">
            <div class="card">
                <div class="card-value" id="podCount">-</div>
                <div class="card-label">Total Pods</div>
            </div>
            <div class="card">
                <div class="card-value" id="totalCPU">-</div>
                <div class="card-label">Allocated vCPU</div>
            </div>
            <div class="card">
                <div class="card-value" id="totalGPU">-</div>
                <div class="card-label">Allocated GPUs</div>
            </div>
            <div class="card">
                <div class="card-value" id="futureStat">-</div>
                <div class="card-label">Future Metric</div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="resourceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pods-tab" data-bs-toggle="tab" data-bs-target="#pods" type="button" role="tab" aria-controls="pods" aria-selected="true">Pods</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab" aria-controls="services" aria-selected="false">Services</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inferenceservices-tab" data-bs-toggle="tab" data-bs-target="#inferenceservices" type="button" role="tab" aria-controls="inferenceservices" aria-selected="false">InferenceServices</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="deployments-tab" data-bs-toggle="tab" data-bs-target="#deployments" type="button" role="tab" aria-controls="deployments" aria-selected="false">Deployments</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="configmaps-tab" data-bs-toggle="tab" data-bs-target="#configmaps" type="button" role="tab" aria-controls="configmaps" aria-selected="false">ConfigMaps</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="secrets-tab" data-bs-toggle="tab" data-bs-target="#secrets" type="button" role="tab" aria-controls="secrets" aria-selected="false">Secrets</button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="resourceTabsContent">
            <div class="tab-pane fade show active" id="pods" role="tabpanel" aria-labelledby="pods-tab">
                <div class="loading-container" id="podsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="resource-table-container">
                    <table class="resource-table" id="podsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Ready</th>
                                <th>Status</th>
                                <th>Restarts</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="services" role="tabpanel" aria-labelledby="services-tab">
                <div class="loading-container" id="servicesLoading">
                    <div class="spinner"></div>
                </div>
                <div class="resource-table-container">
                    <table class="resource-table" id="servicesTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Cluster-IP</th>
                                <th>External-IP</th>
                                <th>Ports</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="inferenceservices" role="tabpanel" aria-labelledby="inferenceservices-tab">
                <div class="loading-container" id="inferenceLoading">
                    <div class="spinner"></div>
                </div>
                <div class="resource-table-container">
                    <table class="resource-table" id="inferenceservicesTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Ready</th>
                                <th>Default Traffic</th>
                                <th>Canary Traffic</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="deployments" role="tabpanel" aria-labelledby="deployments-tab">
                <div class="loading-container" id="deploymentsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="resource-table-container">
                    <table class="resource-table" id="deploymentsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Ready</th>
                                <th>Up-to-date</th>
                                <th>Available</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="configmaps" role="tabpanel" aria-labelledby="configmaps-tab">
                <div class="loading-container" id="configmapsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="resource-table-container">
                    <table class="resource-table" id="configmapsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Data</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="secrets" role="tabpanel" aria-labelledby="secrets-tab">
                <div class="loading-container" id="secretsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="resource-table-container">
                    <table class="resource-table" id="secretsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Data</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="cli" role="tabpanel" aria-labelledby="cli-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">CLI Commands</h1>
        </div>
        <div class="alert alert-info mb-3">
            <h5><i class="fas fa-info-circle"></i> Interactive Terminal</h5>
            <p>You can now type directly in the terminal below. Press Enter to execute commands.</p>
            <ul>
                <li>Use <kbd>Up</kbd> and <kbd>Down</kbd> arrow keys to navigate command history</li>
                <li>Commands are executed in the cluster's environment</li>
                <li>The terminal supports standard kubectl commands</li>
            </ul>
        </div>
        <div id="terminal" style="width: 100%; height: 400px; border-radius: 5px; overflow: hidden;"></div>
    </div>
    <div class="tab-pane fade" id="yaml" role="tabpanel" aria-labelledby="yaml-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Upload YAML</h1>
        </div>
        <div class="drop-zone">
            <span class="drop-zone__prompt">Drop YAML file here or click to upload</span>
            <input type="file" name="myFile" class="drop-zone__input" accept=".yaml">
        </div>
        <div class="text-center mt-3">
            <button id="deployButton" class="btn btn-primary" style="display: none;" onclick="deployYaml()">Deploy</button>
        </div>
        <div class="mt-3">
            <pre id="yamlOutput"></pre>
        </div>
    </div>
    <div class="tab-pane fade" id="events" role="tabpanel" aria-labelledby="events-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h2>Events</h2>
        </div>
        <div class="mb-3">
            <label for="namespaceSelect" class="form-label">Select Namespace:</label>
            <select id="namespaceSelect" class="form-select">
                <option value="">Select a namespace</option>
            </select>
        </div>
        <pre id="eventsOutput" class="mt-3"></pre>
    </div>
    <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h2>Settings</h2>
        </div>
        
        <div id="githubSettings">
            <div class="mb-3">
                <label for="githubRepo" class="form-label">GitHub Repository URL:</label>
                <input type="text" class="form-control" id="githubRepo" placeholder="https://github.com/username/repo">
            </div>
            <button class="btn btn-primary" onclick="updateFromGithub()">Update from GitHub</button>
            
            <!-- New Refresh Button Section -->
            <div class="mt-4 border-top pt-3">
                <h4>Application Refresh</h4>
                <p class="text-muted">
                    This will stop the application, perform a hard pull on the GitHub repository, 
                    and restart the application with the latest code.
                </p>
                <button class="btn btn-warning" onclick="refreshApplication()">
                    <i class="fas fa-sync-alt"></i> Refresh Application
                </button>
            </div>
            
            <!-- Log Display Area -->
            <div class="mt-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Refresh Log</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearRefreshLog()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="refreshLog" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                            <div class="text-muted">-- Log will appear here during refresh operations --</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="updateStatus" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
// Main initialization function that runs when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM content loaded, initializing application...');
    
    // Since scripts are loaded in head, we can initialize right away
    initializeApp();
    
    // Add page visibility change detection for better navigation handling
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            console.log('Page is now visible, checking resource loading state...');
            // Check if any tab content is visible but not loaded
            const activeTabId = document.querySelector('.tab-pane.active').id;
            if (activeTabId && ['pods', 'services', 'inferenceservices', 'deployments', 'configmaps', 'secrets'].includes(activeTabId)) {
                if (!window.loadedResources || !window.loadedResources[activeTabId]) {
                    console.log(`Active tab ${activeTabId} not loaded, fetching data...`);
                    fetchResourceData(activeTabId);
                }
            }
        }
    });
});

// Main application initialization
function initializeApp() {
    console.log('Initializing application...');
    
    // Initialize components that don't require special dependencies
    fetchResourcesForAllTabs();
    checkGitAvailability();
    fetchNamespaces();
    setupDropZone();
    
    // Initialize terminal if available
    initializeTerminal();
    
    // Connect socket event listeners
    connectSocketListeners();
    
    console.log('Application initialized');
}

// Terminal initialization - already loaded in head
function initializeTerminal() {
    if (document.getElementById('terminal')) {
        try {
            console.log('Initializing terminal...');
            
            // Create terminal with FitAddon for proper sizing
            const terminal = new Terminal({
                cursorBlink: true,
                fontFamily: 'monospace',
                fontSize: 14,
                convertEol: true,
                scrollback: 1000,
                theme: {
                    background: '#000000',
                    foreground: '#ffffff'
                }
            });
            
            // Store terminal in global state
            window.app.terminal = terminal;
            
            // Open terminal
            terminal.open(document.getElementById('terminal'));
            
            // Setup command input handling
            let currentLine = '';
            let commandHistory = [];
            let historyIndex = -1;
            
            // Initial prompt
            if (window.app.socket) {
                terminal.write('\r\n$ ');
                
                // Listen for terminal output from server
                window.app.socket.on('output', function(data) {
                    if (window.app.terminal) {
                        window.app.terminal.write(data.data);
                        // Write prompt after server response
                        window.app.terminal.write('\r\n$ ');
                        currentLine = '';
                    }
                });
                
                // Handle user input
                terminal.onKey(({ key, domEvent }) => {
                    const printable = !domEvent.altKey && !domEvent.altGraphKey && !domEvent.ctrlKey && !domEvent.metaKey;
                    
                    // Handle special keys
                    if (domEvent.keyCode === 13) { // Enter key
                        // Send command to server
                        if (currentLine.trim()) {
                            // Add to history
                            commandHistory.push(currentLine);
                            historyIndex = commandHistory.length;
                            
                            // Send to server
                            window.app.socket.emit('run_cli_command', { command: currentLine });
                            
                            // Visual feedback but wait for server response for prompt
                            terminal.write('\r\n');
                            currentLine = '';
                        } else {
                            // Empty command, just show new prompt
                            terminal.write('\r\n$ ');
                        }
                    } else if (domEvent.keyCode === 8) { // Backspace
                        if (currentLine.length > 0) {
                            currentLine = currentLine.slice(0, -1);
                            terminal.write('\b \b'); // Erase character
                        }
                    } else if (domEvent.keyCode === 38) { // Up arrow - history
                        if (historyIndex > 0) {
                            historyIndex--;
                            // Clear current line
                            terminal.write('\r$ ' + ' '.repeat(currentLine.length) + '\r$ ');
                            // Display command from history
                            currentLine = commandHistory[historyIndex];
                            terminal.write(currentLine);
                        }
                    } else if (domEvent.keyCode === 40) { // Down arrow - history
                        if (historyIndex < commandHistory.length - 1) {
                            historyIndex++;
                            // Clear current line
                            terminal.write('\r$ ' + ' '.repeat(currentLine.length) + '\r$ ');
                            // Display next command from history
                            currentLine = commandHistory[historyIndex];
                            terminal.write(currentLine);
                        } else if (historyIndex === commandHistory.length - 1) {
                            historyIndex = commandHistory.length;
                            // Clear current line
                            terminal.write('\r$ ' + ' '.repeat(currentLine.length) + '\r$ ');
                            currentLine = '';
                        }
                    } else if (printable) {
                        // Regular printable character
                        currentLine += key;
                        terminal.write(key);
                    }
                });
                
                console.log('Terminal initialized successfully with interactive mode');
            } else {
                terminal.write('\r\n\x1b[31mError: Socket connection not available. Terminal functionality is limited.\x1b[0m\r\n');
                console.warn('Socket not available for terminal output');
            }
        } catch (error) {
            console.error('Failed to initialize terminal:', error);
            const terminalElement = document.getElementById('terminal');
            terminalElement.innerHTML = '<div class="alert alert-danger">Failed to initialize terminal: ' + error.message + '</div>';
        }
    }
}

// Socket event listeners
function connectSocketListeners() {
    const socket = window.app.socket;
    if (!socket) {
        console.warn('Socket not available for event listeners');
        return;
    }
    
    // Refresh log listener for the settings page
    const refreshLog = document.getElementById('refreshLog');
    if (refreshLog) {
        socket.on('refresh_log', function(data) {
            const logMessage = data.message;
            
            // Create new log entry with appropriate class based on status
            const logEntry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            // Set class based on status
            if (data.status === 'error') {
                logEntry.className = 'text-danger';
            } else if (data.status === 'warning') {
                logEntry.className = 'text-warning';
            } else if (data.status === 'success') {
                logEntry.className = 'text-success';
            } else {
                logEntry.className = 'text-info';
            }
            
            logEntry.innerHTML = `[${timestamp}] ${logMessage}`;
            refreshLog.appendChild(logEntry);
            
            // Auto-scroll to the bottom
            refreshLog.scrollTop = refreshLog.scrollHeight;
            
            // If this is a completion message, trigger the restart
            if (logMessage.includes('Preparing to restart application')) {
                // Wait a moment to ensure the user sees the restart message
                setTimeout(() => {
                    fetch('/restart', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const statusDiv = document.getElementById('updateStatus');
                        if (data.status === 'success') {
                            const logEntry = document.createElement('div');
                            logEntry.className = 'text-success';
                            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] Application restarted successfully. Page will refresh shortly...`;
                            refreshLog.appendChild(logEntry);
                            
                            statusDiv.innerHTML = 'Application restarted successfully. Refreshing page...';
                            setTimeout(() => {
                                window.location.reload();
                            }, 3000);
                        }
                    });
                }, 1000);
            }
        });
    }
}

// Fetch all resources for each tab
function fetchResourcesForAllTabs() {
    const resourceTypes = ['pods', 'services', 'inferenceservices', 'deployments', 'configmaps', 'secrets'];
    
    // Track loaded resources to avoid unnecessary reloading
    window.loadedResources = window.loadedResources || {};
    
    // Add controls to each resource tab and set up click handlers 
    resourceTypes.forEach(resourceType => {
        // Initialize loading indicators
        showLoading(resourceType);
        
        // Add refresh button and search bar to each resource tab
        addResourceControls(resourceType);
        
        // Set up tab click handlers to load data on demand
        const tabElement = document.querySelector(`#${resourceType}-tab`);
        if (tabElement) {
            tabElement.addEventListener('click', () => {
                // Only fetch data if not already loaded
                if (!window.loadedResources[resourceType]) {
                    fetchResourceData(resourceType);
                }
            });
        }
    });
    
    // Only load the active tab initially
    const activeTabId = document.querySelector('.tab-pane.active').id;
    if (activeTabId && resourceTypes.includes(activeTabId)) {
        fetchResourceData(activeTabId);
    } else {
        // If no tab is active, load pods as default
        fetchResourceData('pods');
    }
    
    // Set up a failsafe to check if the resources loaded correctly
    setTimeout(() => {
        const activeTabId = document.querySelector('.tab-pane.active').id;
        if (activeTabId && resourceTypes.includes(activeTabId)) {
            const tableBody = document.querySelector(`#${activeTabId}Table tbody`);
            if (tableBody && (tableBody.children.length === 0 || !window.loadedResources[activeTabId])) {
                console.log(`No data found in ${activeTabId} after initial load, retrying...`);
                fetchResourceData(activeTabId);
            }
        }
    }, 5000);
}

// Add refresh button and search bar to each resource tab
function addResourceControls(resourceType) {
    const tabPane = document.getElementById(resourceType);
    if (!tabPane) return;
    
    // Find where to insert controls (before the table)
    let tableContainer = tabPane.querySelector('.resource-table-container');
    if (!tableContainer) return;
    
    // Create controls container
    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'mb-3 d-flex justify-content-between align-items-center';
    
    // Create search input
    const searchContainer = document.createElement('div');
    searchContainer.className = 'input-group w-50';
    searchContainer.innerHTML = `
        <input type="text" class="form-control" placeholder="Filter ${resourceType}..." id="${resourceType}Search">
        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch('${resourceType}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Create refresh button
    const refreshButton = document.createElement('button');
    refreshButton.className = 'btn btn-primary';
    refreshButton.innerHTML = `<i class="fas fa-sync-alt"></i> Refresh ${capitalizeFirstLetter(resourceType)}`;
    refreshButton.onclick = function() { 
        // Force refresh by clearing the cached data
        if (window.loadedResources) {
            delete window.loadedResources[resourceType];
        }
        fetchResourceData(resourceType); 
    };
    
    // Add components to the container
    controlsContainer.appendChild(searchContainer);
    controlsContainer.appendChild(refreshButton);
    
    // Insert controls before the table
    tabPane.insertBefore(controlsContainer, tableContainer);
    
    // Add event listener for search input
    const searchInput = document.getElementById(`${resourceType}Search`);
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterResources(resourceType, this.value);
        });
    }
}

// Capitalize first letter helper (for button labels)
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

// Clear search field and reset table
function clearSearch(resourceType) {
    const searchInput = document.getElementById(`${resourceType}Search`);
    if (searchInput) {
        searchInput.value = '';
        filterResources(resourceType, '');
    }
}

// Filter resources based on search term
function filterResources(resourceType, searchTerm) {
    const tableBody = document.querySelector(`#${resourceType}Table tbody`);
    if (!tableBody) return;
    
    const rows = tableBody.querySelectorAll('tr');
    const searchTermLower = searchTerm.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const shouldShow = searchTerm === '' || text.includes(searchTermLower);
        row.style.display = shouldShow ? '' : 'none';
    });
    
    // Show a message if no results
    let noResultsRow = tableBody.querySelector('.no-results-row');
    
    if (searchTerm !== '' && ![...rows].some(row => row.style.display !== 'none' && !row.classList.contains('no-results-row'))) {
        // No visible rows and search is active
        if (!noResultsRow) {
            noResultsRow = document.createElement('tr');
            noResultsRow.className = 'no-results-row';
            noResultsRow.innerHTML = `<td colspan="7" class="text-center">No ${resourceType} matching "${searchTerm}"</td>`;
            tableBody.appendChild(noResultsRow);
        } else {
            noResultsRow.querySelector('td').textContent = `No ${resourceType} matching "${searchTerm}"`;
            noResultsRow.style.display = '';
        }
    } else if (noResultsRow) {
        // Hide the no results message if there are visible rows or search is cleared
        noResultsRow.style.display = 'none';
    }
}

// Resource data fetching (for individual tab clicks or refresh button)
function fetchResourceData(resourceType) {
    console.log(`Fetching ${resourceType} data...`);
    
    // Save the current search term before refreshing
    const searchInput = document.getElementById(`${resourceType}Search`);
    const searchTerm = searchInput ? searchInput.value : '';
    
    showLoading(resourceType);
    
    fetch('/get_resources', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `resource_type=${resourceType}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        const tableBody = document.querySelector(`#${resourceType}Table tbody`);
        if (!tableBody) {
            console.warn(`Table body for ${resourceType} not found`);
            hideLoading(resourceType);
            return;
        }
        
        tableBody.innerHTML = ''; // Clear existing rows
        
        if (data.format === 'error') {
            tableBody.innerHTML = `<tr><td colspan="7">Unable to fetch ${resourceType}: ${data.message}</td></tr>`;
            hideLoading(resourceType);
            return;
        }
        
        // For empty results, show a message
        if (!data.data.items || data.data.items.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No ${resourceType} found</td></tr>`;
            hideLoading(resourceType);
            return;
        }
        
        data.data.items.forEach(item => {
            const row = document.createElement('tr');
            switch (resourceType) {
                case 'pods':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.containerStatuses ? item.status.containerStatuses[0].ready : 'N/A'}</td>
                        <td>${getStatusIcon(item.status.phase)}${item.status.phase}</td>
                        <td>${item.status.containerStatuses ? item.status.containerStatuses[0].restartCount : 'N/A'}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'services':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.spec.type}</td>
                        <td>${item.spec.clusterIP}</td>
                        <td>${item.spec.externalIP || 'N/A'}</td>
                        <td>${item.spec.ports.map(port => `${port.port}/${port.protocol}`).join(', ')}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'inferenceservices':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.url || 'N/A'}</td>
                        <td>${getStatusIcon(item.status.conditions[0].status)}${item.status.conditions[0].status}</td>
                        <td>${item.status.traffic ? item.status.traffic[0].percent : 'N/A'}</td>
                        <td>${item.status.traffic && item.status.traffic.length > 1 ? item.status.traffic[1].percent : 'N/A'}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'deployments':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.readyReplicas || 0}/${item.status.replicas}</td>
                        <td>${item.status.updatedReplicas}</td>
                        <td>${item.status.availableReplicas}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'configmaps':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${Object.keys(item.data || {}).length}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'secrets':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.type}</td>
                        <td>${Object.keys(item.data || {}).length}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
            }
            tableBody.appendChild(row);
        });
        
        hideLoading(resourceType);
        
        // Mark this resource type as loaded
        window.loadedResources = window.loadedResources || {};
        window.loadedResources[resourceType] = true;
        
        // Reapply search filter after loading new data
        if (searchTerm) {
            filterResources(resourceType, searchTerm);
        }
        
        console.log(`${resourceType} data loaded successfully`);
    })
    .catch(error => {
        console.error(`Error fetching ${resourceType}:`, error);
        hideLoading(resourceType);
        
        const tableBody = document.querySelector(`#${resourceType}Table tbody`);
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">
                <i class="fas fa-exclamation-triangle"></i> Error fetching ${resourceType}: ${error.message}
            </td></tr>`;
        }
    });
}

// UI helpers
function showLoading(resourceType) {
    const loadingElement = document.getElementById(`${resourceType}Loading`);
    const tableElement = document.getElementById(`${resourceType}Table`);
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (tableElement) tableElement.style.display = 'none';
}

function hideLoading(resourceType) {
    const loadingElement = document.getElementById(`${resourceType}Loading`);
    const tableElement = document.getElementById(`${resourceType}Table`);
    
    if (loadingElement) loadingElement.style.display = 'none';
    if (tableElement) tableElement.style.display = 'block';
}

function createActionButton(resourceType, namespace, name) {
    if (resourceType === 'pods') {
        return `
            <div class="d-flex">
                <a href="#" class="me-2" onclick="runAction('logs', '${resourceType}', '${namespace}', '${name}')" title="View Logs">
                    <i class="fas fa-file-alt text-primary"></i>
                </a>
                <a href="/explore/${namespace}/${name}" class="me-2 explore-pod-link" data-namespace="${namespace}" data-pod-name="${name}" title="Explore Pod">
                    <i class="fas fa-terminal text-success"></i>
                </a>
                <a href="#" onclick="runAction('delete', '${resourceType}', '${namespace}', '${name}')" title="Delete">
                    <i class="fas fa-trash-alt text-danger"></i>
                </a>
            </div>
        `;
    } else {
        return `
            <div class="dropdown">
                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="#" onclick="runAction('describe', '${resourceType}', '${namespace}', '${name}')">Describe</a></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('logs', '${resourceType}', '${namespace}', '${name}')">View Logs</a></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('exec', '${resourceType}', '${namespace}', '${name}')">Access</a></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('delete', '${resourceType}', '${namespace}', '${name}')">Delete</a></li>
                </ul>
            </div>
        `;
    }
}

// CLI command execution - no longer needed as we type directly in terminal
function runCliCommand() {
    // This function is no longer needed, but we'll keep it for backward compatibility
    // Commands are now entered directly in the terminal
    const command = document.getElementById('cliCommand');
    if (command && command.value) {
        if (window.app.terminal) {
            const cmd = command.value;
            // Simulate typing the command
            window.app.terminal.write(cmd);
            window.app.terminal.write('\r\n');
            
            // Send the command
            if (window.app.socket) {
                window.app.socket.emit('run_cli_command', { command: cmd });
            }
            
            // Clear the input field
            command.value = '';
        }
    }
}

// YAML deployment
function deployYaml() {
    const fileInput = document.querySelector('.drop-zone__input');
    const file = fileInput.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload_yaml', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('yamlOutput').textContent = data.output || data.error;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('yamlOutput').textContent = 'An error occurred while deploying the YAML file.';
        });
    }
}

// Drop zone setup
function setupDropZone() {
    document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
        const dropZoneElement = inputElement.closest(".drop-zone");
        if (!dropZoneElement) return;

        dropZoneElement.addEventListener("click", (e) => {
            inputElement.click();
        });

        inputElement.addEventListener("change", (e) => {
            if (inputElement.files.length) {
                updateThumbnail(dropZoneElement, inputElement.files[0]);
                const deployButton = document.getElementById('deployButton');
                if (deployButton) {
                    deployButton.style.display = 'inline-block';
                }
            }
        });

        dropZoneElement.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZoneElement.classList.add("drop-zone--over");
        });

        ["dragleave", "dragend"].forEach((type) => {
            dropZoneElement.addEventListener(type, (e) => {
                dropZoneElement.classList.remove("drop-zone--over");
            });
        });

        dropZoneElement.addEventListener("drop", (e) => {
            e.preventDefault();

            if (e.dataTransfer.files.length) {
                inputElement.files = e.dataTransfer.files;
                updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
                const deployButton = document.getElementById('deployButton');
                if (deployButton) {
                    deployButton.style.display = 'inline-block';
                }
            }

            dropZoneElement.classList.remove("drop-zone--over");
        });
    });
}

function updateThumbnail(dropZoneElement, file) {
    let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

    if (dropZoneElement.querySelector(".drop-zone__prompt")) {
        dropZoneElement.querySelector(".drop-zone__prompt").remove();
    }

    if (!thumbnailElement) {
        thumbnailElement = document.createElement("div");
        thumbnailElement.classList.add("drop-zone__thumb");
        dropZoneElement.appendChild(thumbnailElement);
    }

    thumbnailElement.dataset.label = file.name;

    if (file.type.startsWith("image/")) {
        const reader = new FileReader();

        reader.readAsDataURL(file);
        reader.onload = () => {
            thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
        };
    } else {
        thumbnailElement.style.backgroundImage = null;
    }
}

// Check git availability
function checkGitAvailability() {
    fetch('/git_status')
    .then(response => response.json())
    .then(data => {
        const githubSettings = document.getElementById('githubSettings');
        if (githubSettings) {
        if (!data.available) {
            githubSettings.innerHTML = `
                <div class="alert alert-warning">
                    <strong>Git functionality is not available.</strong> 
                    <p>The "Update from GitHub" feature requires git to be installed on the server. 
                    Please install git or contact your administrator if you need this feature.</p>
                </div>
            `;
            }
        }
    })
    .catch(error => {
        console.error('Error checking git status:', error);
    });
}

// Fetch namespaces for events tab
function fetchNamespaces() {
    fetch('/get_namespaces')
        .then(response => response.json())
        .then(data => {
            const namespaceSelect = document.getElementById('namespaceSelect');
            if (!namespaceSelect) return;
            
            namespaceSelect.innerHTML = '<option value="">Select a namespace</option>';
            
            if (data.namespaces) {
                data.namespaces.forEach(namespace => {
                    const option = document.createElement('option');
                    option.value = namespace;
                    option.textContent = namespace;
                    namespaceSelect.appendChild(option);
                });
            } else if (data.error) {
                console.error('Error fetching namespaces:', data.error);
            }
            
            // Set up event listener for namespace selection
            namespaceSelect.addEventListener('change', function() {
                if (this.value) {
                    fetchEvents(this.value);
                }
            });
        })
        .catch(error => {
            console.error('Error fetching namespaces:', error);
        });
}

// Fetch events for selected namespace
function fetchEvents(namespace) {
    const eventsOutput = document.getElementById('eventsOutput');
    if (!eventsOutput) return;
    
    eventsOutput.textContent = 'Loading events...';
    
    fetch('/get_events', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}`
    })
    .then(response => response.json())
    .then(data => {
        eventsOutput.textContent = data.output;
    })
    .catch(error => {
        console.error('Error fetching events:', error);
        eventsOutput.textContent = 'An error occurred while fetching events.';
    });
}

// GitHub update function
function updateFromGithub() {
    const repoUrl = document.getElementById('githubRepo').value;
    const statusDiv = document.getElementById('updateStatus');
    
    if (!statusDiv) return;
    
    statusDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Updating from GitHub...';
    
    // First update from GitHub
    fetch('/update_from_github', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            repo_url: repoUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            statusDiv.innerHTML = 'Update successful. Initiating application restart...';
            
            // Then restart the application
            fetch('/restart', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    // If the server is already restarting, we might get an error response
                    // This is normal, so handle it gracefully
                    statusDiv.innerHTML = 'Application is restarting. Waiting for it to come back online...';
                    waitForApplicationRestart(statusDiv);
                    throw new Error('restart_in_progress');
                }
            })
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.innerHTML = 'Application restart initiated. Waiting for application to come back online...';
                    waitForApplicationRestart(statusDiv);
                }
            })
            .catch(error => {
                if (error.message !== 'restart_in_progress') {
                    console.error('Error during restart:', error);
                    statusDiv.innerHTML = `<div class="alert alert-warning">Restart initiated, but couldn't confirm status. Will try to reconnect.</div>`;
                    waitForApplicationRestart(statusDiv);
                }
            });
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
            throw new Error(data.message);
        }
    })
    .catch(error => {
        if (error.message !== 'restart_in_progress') {
            console.error('Error:', error);
            if (statusDiv && !statusDiv.innerHTML.includes('alert-danger')) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
    });
}

// Application refresh function (for the refresh button)
function refreshApplication() {
    const refreshLog = document.getElementById('refreshLog');
    const statusDiv = document.getElementById('updateStatus');
    
    if (!refreshLog || !statusDiv) {
        console.error('Required elements not found');
        return;
    }
    
    // Clear the log
    refreshLog.innerHTML = '';
    
    // Add initial message
    const logEntry = document.createElement('div');
    logEntry.className = 'text-info';
    logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] Starting refresh process...`;
    refreshLog.appendChild(logEntry);
    
    statusDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Refreshing application...';
    
    // Get the repo URL from the input field
    const repoUrl = document.getElementById('githubRepo').value;
    
    fetch('/refresh_application', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            repo_url: repoUrl || undefined  // Only send if user provided a value
        })
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            // If the request fails, it might be because the app is already restarting
            logMessage(refreshLog, 'Application restart initiated. Waiting for server to come back online...', 'info');
            statusDiv.innerHTML = 'Application is restarting. Waiting for it to come back online...';
            waitForApplicationRestart(statusDiv, refreshLog);
            throw new Error('restart_in_progress');
        }
    })
    .then(data => {
        if (data && data.status === 'success') {
            logMessage(refreshLog, 'Refresh operation successful, application restart initiated.', 'success');
            statusDiv.innerHTML = 'Application is restarting. Waiting for it to come back online...';
            waitForApplicationRestart(statusDiv, refreshLog);
        } else if (data && data.error) {
            logMessage(refreshLog, `Error: ${data.error}`, 'error');
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        if (error.message !== 'restart_in_progress') {
            console.error('Error:', error);
            logMessage(refreshLog, `Error: ${error.message}`, 'error');
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });
}

// Helper to add log messages to the refresh log
function logMessage(refreshLog, message, status) {
    if (!refreshLog) return;
    
    const logEntry = document.createElement('div');
    const timestamp = new Date().toLocaleTimeString();
    
    // Set class based on status
    if (status === 'error') {
        logEntry.className = 'text-danger';
    } else if (status === 'warning') {
        logEntry.className = 'text-warning';
    } else if (status === 'success') {
        logEntry.className = 'text-success';
    } else {
        logEntry.className = 'text-info';
    }
    
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    refreshLog.appendChild(logEntry);
    
    // Auto-scroll to the bottom
    refreshLog.scrollTop = refreshLog.scrollHeight;
}

// Function to poll and wait for application to restart
function waitForApplicationRestart(statusDiv, refreshLog = null) {
    const MAX_ATTEMPTS = 30; // Try for up to 30 seconds
    let attempts = 0;
    
    // Update UI to show we're waiting
    if (statusDiv) {
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Waiting for application to restart...
                </div>
                <div class="progress mt-2" style="height: 5px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        `;
    }
    
    if (refreshLog) {
        logMessage(refreshLog, "Application is restarting. Waiting for it to come back online...", "info");
    }
    
    // Set up polling
    const checkServer = function() {
        attempts++;
        
        // Update progress bar
        if (statusDiv) {
            const progressBar = statusDiv.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${Math.min((attempts / MAX_ATTEMPTS) * 100, 100)}%`;
            }
        }
        
        // Try a lightweight request to check if server is back
        fetch('/health_check', { 
            method: 'GET',
            // Add cache-busting to prevent cached responses
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        })
        .then(response => {
            if (response.ok) {
                // Server is back online!
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> Application restarted successfully!
                        </div>
                    `;
                }
                
                if (refreshLog) {
                    logMessage(refreshLog, "Application is back online! Refreshing page in 3 seconds...", "success");
                }
                
                // Refresh the page after a short delay to let the user see the success message
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                // Server responded but with an error
                if (attempts < MAX_ATTEMPTS) {
                    setTimeout(checkServer, 1000);
                } else {
                    handleTimeout();
                }
            }
        })
        .catch(error => {
            // Server is still down, or network error
            if (attempts < MAX_ATTEMPTS) {
                setTimeout(checkServer, 1000);
            } else {
                handleTimeout();
            }
        });
    };
    
    // Function to handle timeout case
    const handleTimeout = function() {
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> The application is taking longer than expected to restart.
                    <button class="btn btn-sm btn-primary mt-2" onclick="window.location.reload()">
                        Refresh Now
                    </button>
                </div>
            `;
        }
        
        if (refreshLog) {
            logMessage(refreshLog, "Application is taking longer than expected to restart. You may need to refresh manually.", "warning");
        }
    };
    
    // Start polling after a short delay to allow the server to begin restarting
    setTimeout(checkServer, 2000);
}

// Clear refresh log
function clearRefreshLog() {
    const refreshLog = document.getElementById('refreshLog');
    if (refreshLog) {
        refreshLog.innerHTML = '<div class="text-muted">-- Log will appear here during refresh operations --</div>';
    }
}

// Navigation function to handle explore pod links
document.addEventListener('click', function(e) {
    // Use delegation to handle clicks on explore pod links
    const exploreLink = e.target.closest('.explore-pod-link');
    if (exploreLink) {
        e.preventDefault();
        const namespace = exploreLink.dataset.namespace;
        const podName = exploreLink.dataset.podName;
        const url = `/explore/${namespace}/${podName}`;
        
        console.log(`Navigating to pod explorer: ${url}`);
        
        // Navigate to the explore page using full page navigation
        window.location.href = url;
    }
});

// Update the dashboard metrics on page load
function updateDashboardMetrics() {
    // Get pod count
    $.post('/get_resources', { resource_type: 'pods' }, function(response) {
        if (response.format === 'table' && response.data && response.data.items) {
            $('#podCount').text(response.data.items.length);
        }
    });

    // Calculate total allocated CPU and GPU
    let totalCPU = 0;
    let totalGPU = 0;

    $.post('/get_resources', { resource_type: 'pods' }, function(response) {
        if (response.format === 'table' && response.data && response.data.items) {
            response.data.items.forEach(pod => {
                if (pod.status.phase === 'Running' && pod.spec.containers) {
                    pod.spec.containers.forEach(container => {
                        if (container.resources && container.resources.requests) {
                            // Count CPU
                            if (container.resources.requests.cpu) {
                                const cpuStr = container.resources.requests.cpu;
                                if (cpuStr.endsWith('m')) {
                                    totalCPU += parseInt(cpuStr.slice(0, -1)) / 1000;
                                } else {
                                    totalCPU += parseInt(cpuStr);
                                }
                            }

                            // Count GPU
                            if (container.resources.requests['nvidia.com/gpu']) {
                                totalGPU += parseInt(container.resources.requests['nvidia.com/gpu']);
                            }
                        }
                    });
                }
            });

            // Update the dashboard
            $('#totalCPU').text(totalCPU.toFixed(1));
            $('#totalGPU').text(totalGPU);
        }
    });
}

// Function to generate the action dropdown menu
function generateActionsDropdown(namespace, resourceName, resourceType) {
    let actionsHtml = '<div class="action-dropdown">';
    actionsHtml += '<button class="three-dots-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button>';
    actionsHtml += '<div class="dropdown-menu dropdown-menu-end">';
    
    if (resourceType === 'pods') {
        actionsHtml += `<a class="dropdown-item view-details" href="#" data-namespace="${namespace}" data-name="${resourceName}" data-action="describe">Describe</a>`;
        actionsHtml += `<a class="dropdown-item view-logs" href="#" data-namespace="${namespace}" data-name="${resourceName}">Logs</a>`;
        actionsHtml += `<a class="dropdown-item view-explore" href="/explore/${namespace}/${resourceName}" target="_blank">Explore</a>`;
        actionsHtml += `<a class="dropdown-item delete-resource" href="#" data-namespace="${namespace}" data-name="${resourceName}" data-resource-type="${resourceType}">Delete</a>`;
    } else {
        actionsHtml += `<a class="dropdown-item view-details" href="#" data-namespace="${namespace}" data-name="${resourceName}" data-resource-type="${resourceType}" data-action="describe">Describe</a>`;
        actionsHtml += `<a class="dropdown-item delete-resource" href="#" data-namespace="${namespace}" data-name="${resourceName}" data-resource-type="${resourceType}">Delete</a>`;
    }
    
    actionsHtml += '</div></div>';
    return actionsHtml;
}

// Update existing resource table population functions to use the new dropdown
function loadResources(resourceType) {
    // Show loading spinner
    $(`#${resourceType}Loading`).show();
    
    // Hide the table while loading
    $(`#${resourceType}Table`).closest('.resource-table-container').hide();
    
    $.post('/get_resources', { resource_type: resourceType }, function(response) {
        // Hide loading spinner
        $(`#${resourceType}Loading`).hide();
        
        // Show the table
        $(`#${resourceType}Table`).closest('.resource-table-container').show();
        
        if (response.format === 'table' && response.data) {
            const items = response.data.items || [];
            
            // Call the appropriate function to populate the table
            switch(resourceType) {
                case 'pods':
                    populatePodsTable(items);
                    break;
                case 'services':
                    populateServicesTable(items);
                    break;
                case 'inferenceservices':
                    populateInferenceServicesTable(items);
                    break;
                case 'deployments':
                    populateDeploymentsTable(items);
                    break;
                case 'configmaps':
                    populateConfigMapsTable(items);
                    break;
                case 'secrets':
                    populateSecretsTable(items);
                    break;
            }
        } else {
            $(`#${resourceType}Table tbody`).html('<tr><td colspan="100%">No data available</td></tr>');
        }
    });
}

// Function for pods table
function populatePodsTable(pods) {
    const table = $('#podsTable tbody');
    table.empty();
    
    pods.forEach(function(pod) {
        const statusClass = getStatusClass(pod.status.phase);
        const ready = `${pod.status.containerStatuses ? pod.status.containerStatuses.filter(cs => cs.ready).length : 0}/${pod.spec.containers.length}`;
        const restarts = pod.status.containerStatuses ? pod.status.containerStatuses.reduce((sum, cs) => sum + cs.restartCount, 0) : 0;
        const age = calculateAge(pod.metadata.creationTimestamp);
        
        const row = $('<tr>');
        row.append($('<td>').text(pod.metadata.namespace));
        row.append($('<td>').text(pod.metadata.name));
        row.append($('<td>').text(ready));
        row.append($('<td>').html(`<span class="status-icon status-${statusClass.toLowerCase()}"></span>${pod.status.phase}`));
        row.append($('<td>').text(restarts));
        row.append($('<td>').text(age));
        row.append($('<td>').html(generateActionsDropdown(pod.metadata.namespace, pod.metadata.name, 'pods')));
        
        table.append(row);
    });
    
    // Initialize action handlers
    initializeActionHandlers();
}

// Function for services table
function populateServicesTable(services) {
    const table = $('#servicesTable tbody');
    table.empty();
    
    services.forEach(function(service) {
        const row = $('<tr>');
        
        // Extract service details
        const namespace = service.metadata.namespace;
        const name = service.metadata.name;
        const type = service.spec.type;
        const clusterIP = service.spec.clusterIP;
        const externalIP = service.status && service.status.loadBalancer && service.status.loadBalancer.ingress 
            ? service.status.loadBalancer.ingress.map(ing => ing.ip || ing.hostname).join(', ') 
            : '-';
        
        // Format ports
        const portsStr = service.spec.ports 
            ? service.spec.ports.map(p => `${p.port}${p.targetPort ? `:${p.targetPort}` : ''}/${p.protocol || 'TCP'}`).join(', ')
            : '-';
            
        const age = calculateAge(service.metadata.creationTimestamp);
        
        // Create the row cells
        row.append($('<td>').text(namespace));
        row.append($('<td>').text(name));
        row.append($('<td>').text(type));
        row.append($('<td>').text(clusterIP));
        row.append($('<td>').text(externalIP));
        row.append($('<td>').text(portsStr));
        row.append($('<td>').text(age));
        row.append($('<td>').html(generateActionsDropdown(namespace, name, 'services')));
        
        table.append(row);
    });
    
    // Initialize action handlers
    initializeActionHandlers();
}

// Function for inference services table
function populateInferenceServicesTable(inferenceServices) {
    const table = $('#inferenceservicesTable tbody');
    table.empty();
    
    inferenceServices.forEach(function(svc) {
        const row = $('<tr>');
        
        // Extract details
        const namespace = svc.metadata.namespace;
        const name = svc.metadata.name;
        const url = svc.status && svc.status.url ? svc.status.url : '-';
        const ready = svc.status && svc.status.conditions ? 
            svc.status.conditions.some(c => c.type === 'Ready' && c.status === 'True') ? 'True' : 'False'
            : 'Unknown';
        const defaultTraffic = svc.status && svc.status.components && svc.status.components.default ? 
            svc.status.components.default.traffic || '100%' : '100%';
        const canaryTraffic = svc.status && svc.status.components && svc.status.components.canary ?
            svc.status.components.canary.traffic || '0%' : '0%';
        const age = calculateAge(svc.metadata.creationTimestamp);
        
        // Create row cells
        row.append($('<td>').text(namespace));
        row.append($('<td>').text(name));
        row.append($('<td>').text(url));
        row.append($('<td>').text(ready));
        row.append($('<td>').text(defaultTraffic));
        row.append($('<td>').text(canaryTraffic));
        row.append($('<td>').text(age));
        row.append($('<td>').html(generateActionsDropdown(namespace, name, 'inferenceservices')));
        
        table.append(row);
    });
    
    // Initialize action handlers
    initializeActionHandlers();
}

// Function for deployments table
function populateDeploymentsTable(deployments) {
    const table = $('#deploymentsTable tbody');
    table.empty();
    
    deployments.forEach(function(deployment) {
        const row = $('<tr>');
        
        // Extract deployment details
        const namespace = deployment.metadata.namespace;
        const name = deployment.metadata.name;
        const ready = `${deployment.status.readyReplicas || 0}/${deployment.status.replicas || 0}`;
        const upToDate = deployment.status.updatedReplicas || 0;
        const available = deployment.status.availableReplicas || 0;
        const age = calculateAge(deployment.metadata.creationTimestamp);
        
        // Create row cells
        row.append($('<td>').text(namespace));
        row.append($('<td>').text(name));
        row.append($('<td>').text(ready));
        row.append($('<td>').text(upToDate));
        row.append($('<td>').text(available));
        row.append($('<td>').text(age));
        row.append($('<td>').html(generateActionsDropdown(namespace, name, 'deployments')));
        
        table.append(row);
    });
    
    // Initialize action handlers
    initializeActionHandlers();
}

// Function for configmaps table
function populateConfigMapsTable(configmaps) {
    const table = $('#configmapsTable tbody');
    table.empty();
    
    configmaps.forEach(function(configmap) {
        const row = $('<tr>');
        
        // Extract configmap details
        const namespace = configmap.metadata.namespace;
        const name = configmap.metadata.name;
        const dataCount = configmap.data ? Object.keys(configmap.data).length : 0;
        const age = calculateAge(configmap.metadata.creationTimestamp);
        
        // Create row cells
        row.append($('<td>').text(namespace));
        row.append($('<td>').text(name));
        row.append($('<td>').text(dataCount));
        row.append($('<td>').text(age));
        row.append($('<td>').html(generateActionsDropdown(namespace, name, 'configmaps')));
        
        table.append(row);
    });
    
    // Initialize action handlers
    initializeActionHandlers();
}

// Function for secrets table
function populateSecretsTable(secrets) {
    const table = $('#secretsTable tbody');
    table.empty();
    
    secrets.forEach(function(secret) {
        const row = $('<tr>');
        
        // Extract secret details
        const namespace = secret.metadata.namespace;
        const name = secret.metadata.name;
        const type = secret.type || 'Opaque';
        const dataCount = secret.data ? Object.keys(secret.data).length : 0;
        const age = calculateAge(secret.metadata.creationTimestamp);
        
        // Create row cells
        row.append($('<td>').text(namespace));
        row.append($('<td>').text(name));
        row.append($('<td>').text(type));
        row.append($('<td>').text(dataCount));
        row.append($('<td>').text(age));
        row.append($('<td>').html(generateActionsDropdown(namespace, name, 'secrets')));
        
        table.append(row);
    });
    
    // Initialize action handlers
    initializeActionHandlers();
}

// Helper functions
function getStatusClass(status) {
    switch(status) {
        case 'Running':
            return 'Running';
        case 'Pending':
            return 'Pending';
        case 'Failed':
            return 'Failed';
        default:
            return 'Unknown';
    }
}

function calculateAge(timestamp) {
    const created = new Date(timestamp);
    const now = new Date();
    const diffMs = now - created;
    const diffSec = Math.floor(diffMs / 1000);
    
    if (diffSec < 60) return `${diffSec}s`;
    
    const diffMin = Math.floor(diffSec / 60);
    if (diffMin < 60) return `${diffMin}m`;
    
    const diffHour = Math.floor(diffMin / 60);
    if (diffHour < 24) return `${diffHour}h`;
    
    const diffDay = Math.floor(diffHour / 24);
    return `${diffDay}d`;
}

// Initialize action handlers for the dropdown menu items
function initializeActionHandlers() {
    // Describe resource
    $('.view-details').off('click').on('click', function(e) {
        e.preventDefault();
        
        const namespace = $(this).data('namespace');
        const name = $(this).data('name');
        const resourceType = $(this).data('resource-type') || 'pods';
        const action = $(this).data('action') || 'describe';
        
        $('#actionModalLabel').text(`${action.charAt(0).toUpperCase() + action.slice(1)} ${resourceType.charAt(0).toUpperCase() + resourceType.slice(1).replace(/s$/, '')}`);
        $('#actionResult').empty();
        $('#actionLoading').show();
        $('#actionModal').modal('show');
        
        $.post('/run_action', {
            resource_type: resourceType,
            namespace: namespace,
            name: name,
            action: action
        }, function(response) {
            $('#actionLoading').hide();
            $('#actionResult').text(response.output);
        });
    });
    
    // View logs
    $('.view-logs').off('click').on('click', function(e) {
        e.preventDefault();
        
        const namespace = $(this).data('namespace');
        const name = $(this).data('name');
        
        $('#actionModalLabel').text('Pod Logs');
        $('#actionResult').empty();
        $('#actionLoading').show();
        $('#actionModal').modal('show');
        
        $.post('/api/pod/logs', {
            namespace: namespace,
            pod_name: name
        }, function(response) {
            $('#actionLoading').hide();
            $('#actionResult').text(response.logs);
        });
    });
    
    // Delete resource
    $('.delete-resource').off('click').on('click', function(e) {
        e.preventDefault();
        
        const namespace = $(this).data('namespace');
        const name = $(this).data('name');
        const resourceType = $(this).data('resource-type');
        
        if (confirm(`Are you sure you want to delete ${resourceType} "${name}" in namespace "${namespace}"?`)) {
            $('#actionModalLabel').text(`Delete ${resourceType}`);
            $('#actionResult').empty();
            $('#actionLoading').show();
            $('#actionModal').modal('show');
            
            $.post('/run_action', {
                resource_type: resourceType,
                namespace: namespace,
                name: name,
                action: 'delete'
            }, function(response) {
                $('#actionLoading').hide();
                $('#actionResult').text(response.output);
                
                // Reload the resources table after deletion
                setTimeout(function() {
                    loadResources(resourceType);
                }, 1000);
            });
        }
    });
}

// Initialize the dashboard and action handlers when the page is ready
$(document).ready(function() {
    // Update dashboard metrics
    updateDashboardMetrics();
    
    // Load initial resources
    loadResources('pods');
    
    // Tab change handlers
    $('#resourceTabs button').on('click', function (e) {
        const target = $(this).data('bs-target').substring(1);
        loadResources(target);
    });
    
    // Refresh data periodically
    setInterval(function() {
        const activeTab = $('#resourceTabs button.active').data('bs-target').substring(1);
        loadResources(activeTab);
        updateDashboardMetrics();
    }, 30000); // Refresh every 30 seconds
});
</script>
{% endblock %}