{% extends "base.html" %}

{% block title %}Kubernetes Dashboard{% endblock %}

{% block content %}
<div class="tab-content" id="mainContent">
    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Kubernetes Resources</h1>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="resourceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pods-tab" data-bs-toggle="tab" data-bs-target="#pods" type="button" role="tab" aria-controls="pods" aria-selected="true">Pods</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab" aria-controls="services" aria-selected="false">Services</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inferenceservices-tab" data-bs-toggle="tab" data-bs-target="#inferenceservices" type="button" role="tab" aria-controls="inferenceservices" aria-selected="false">InferenceServices</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="deployments-tab" data-bs-toggle="tab" data-bs-target="#deployments" type="button" role="tab" aria-controls="deployments" aria-selected="false">Deployments</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="configmaps-tab" data-bs-toggle="tab" data-bs-target="#configmaps" type="button" role="tab" aria-controls="configmaps" aria-selected="false">ConfigMaps</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="secrets-tab" data-bs-toggle="tab" data-bs-target="#secrets" type="button" role="tab" aria-controls="secrets" aria-selected="false">Secrets</button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="resourceTabsContent">
            <div class="tab-pane fade show active" id="pods" role="tabpanel" aria-labelledby="pods-tab">
                <div class="loading-container" id="podsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="podsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Ready</th>
                                <th>Status</th>
                                <th>Restarts</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="services" role="tabpanel" aria-labelledby="services-tab">
                <div class="loading-container" id="servicesLoading">
                    <div class="spinner"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="servicesTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Cluster-IP</th>
                                <th>External-IP</th>
                                <th>Ports</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="inferenceservices" role="tabpanel" aria-labelledby="inferenceservices-tab">
                <div class="loading-container" id="inferenceLoading">
                    <div class="spinner"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="inferenceservicesTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Ready</th>
                                <th>Default Traffic</th>
                                <th>Canary Traffic</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="deployments" role="tabpanel" aria-labelledby="deployments-tab">
                <div class="loading-container" id="deploymentsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="deploymentsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Ready</th>
                                <th>Up-to-date</th>
                                <th>Available</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="configmaps" role="tabpanel" aria-labelledby="configmaps-tab">
                <div class="loading-container" id="configmapsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="configmapsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Data</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="secrets" role="tabpanel" aria-labelledby="secrets-tab">
                <div class="loading-container" id="secretsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="secretsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Data</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="cli" role="tabpanel" aria-labelledby="cli-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">CLI Commands</h1>
        </div>
        <div id="terminal" style="width: 100%; height: 400px;"></div>
        <input type="text" id="cliCommand" placeholder="Enter command" />
        <button class="btn btn-primary" onclick="runCliCommand()">Run Command</button>
    </div>
    <div class="tab-pane fade" id="yaml" role="tabpanel" aria-labelledby="yaml-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Upload YAML</h1>
        </div>
        <div class="drop-zone">
            <span class="drop-zone__prompt">Drop YAML file here or click to upload</span>
            <input type="file" name="myFile" class="drop-zone__input" accept=".yaml">
        </div>
        <div class="text-center mt-3">
            <button id="deployButton" class="btn btn-primary" style="display: none;" onclick="deployYaml()">Deploy</button>
        </div>
        <div class="mt-3">
            <pre id="yamlOutput"></pre>
        </div>
    </div>
    <div class="tab-pane fade" id="events" role="tabpanel" aria-labelledby="events-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h2>Events</h2>
        </div>
        <div class="mb-3">
            <label for="namespaceSelect" class="form-label">Select Namespace:</label>
            <select id="namespaceSelect" class="form-select">
                <option value="">Select a namespace</option>
            </select>
        </div>
        <pre id="eventsOutput" class="mt-3"></pre>
    </div>
    <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h2>Settings</h2>
        </div>
        
        <div id="githubSettings">
            <div class="mb-3">
                <label for="githubRepo" class="form-label">GitHub Repository URL:</label>
                <input type="text" class="form-control" id="githubRepo" placeholder="https://github.com/username/repo">
            </div>
            <button class="btn btn-primary" onclick="updateFromGithub()">Update from GitHub</button>
            
            <!-- New Refresh Button Section -->
            <div class="mt-4 border-top pt-3">
                <h4>Application Refresh</h4>
                <p class="text-muted">
                    This will stop the application, perform a hard pull on the GitHub repository, 
                    and restart the application with the latest code.
                </p>
                <button class="btn btn-warning" onclick="refreshApplication()">
                    <i class="fas fa-sync-alt"></i> Refresh Application
                </button>
            </div>
            
            <!-- Log Display Area -->
            <div class="mt-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Refresh Log</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearRefreshLog()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="refreshLog" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                            <div class="text-muted">-- Log will appear here during refresh operations --</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="updateStatus" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
// Main initialization function that runs when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM content loaded, initializing application...');
    
    // Since scripts are loaded in head, we can initialize right away
    initializeApp();
});

// Main application initialization
function initializeApp() {
    console.log('Initializing application...');
    
    // Initialize components that don't require special dependencies
    fetchResourcesForAllTabs();
    checkGitAvailability();
    fetchNamespaces();
    setupDropZone();
    
    // Initialize terminal if available
    initializeTerminal();
    
    // Connect socket event listeners
    connectSocketListeners();
    
    console.log('Application initialized');
}

// Terminal initialization - already loaded in head
function initializeTerminal() {
    if (document.getElementById('terminal')) {
        try {
            console.log('Initializing terminal...');
            const terminal = new Terminal();
            window.app.terminal = terminal;
            terminal.open(document.getElementById('terminal'));
            
            if (window.app.socket) {
                window.app.socket.on('output', function(data) {
                    if (window.app.terminal) {
                        window.app.terminal.write(data.data);
                    }
                });
                console.log('Terminal initialized successfully');
            } else {
                console.warn('Socket not available for terminal output');
            }
        } catch (error) {
            console.error('Failed to initialize terminal:', error);
            const terminalElement = document.getElementById('terminal');
            terminalElement.innerHTML = '<div class="alert alert-danger">Failed to initialize terminal: ' + error.message + '</div>';
        }
    }
}

// Socket event listeners
function connectSocketListeners() {
    const socket = window.app.socket;
    if (!socket) {
        console.warn('Socket not available for event listeners');
        return;
    }
    
    // Refresh log listener for the settings page
    const refreshLog = document.getElementById('refreshLog');
    if (refreshLog) {
        socket.on('refresh_log', function(data) {
            const logMessage = data.message;
            
            // Create new log entry with appropriate class based on status
            const logEntry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            // Set class based on status
            if (data.status === 'error') {
                logEntry.className = 'text-danger';
            } else if (data.status === 'warning') {
                logEntry.className = 'text-warning';
            } else if (data.status === 'success') {
                logEntry.className = 'text-success';
            } else {
                logEntry.className = 'text-info';
            }
            
            logEntry.innerHTML = `[${timestamp}] ${logMessage}`;
            refreshLog.appendChild(logEntry);
            
            // Auto-scroll to the bottom
            refreshLog.scrollTop = refreshLog.scrollHeight;
            
            // If this is a completion message, trigger the restart
            if (logMessage.includes('Preparing to restart application')) {
                // Wait a moment to ensure the user sees the restart message
                setTimeout(() => {
                    fetch('/restart', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const statusDiv = document.getElementById('updateStatus');
                        if (data.status === 'success') {
                            const logEntry = document.createElement('div');
                            logEntry.className = 'text-success';
                            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] Application restarted successfully. Page will refresh shortly...`;
                            refreshLog.appendChild(logEntry);
                            
                            statusDiv.innerHTML = 'Application restarted successfully. Refreshing page...';
                            setTimeout(() => {
                                window.location.reload();
                            }, 3000);
                        }
                    });
                }, 1000);
            }
        });
    }
}

// Fetch all resources for each tab
function fetchResourcesForAllTabs() {
    const resourceTypes = ['pods', 'services', 'inferenceservices', 'deployments', 'configmaps', 'secrets'];
    
    // Instead of fetching all resources at once, fetch them sequentially
    // First, initialize all with loading indicators
    resourceTypes.forEach(resourceType => {
        showLoading(resourceType);
        
        // Add refresh button and search bar to each resource tab
        addResourceControls(resourceType);
    });
    
    // Then fetch them one by one for initial load
    fetchResourcesSequentially(resourceTypes, 0);
}

// Add refresh button and search bar to each resource tab
function addResourceControls(resourceType) {
    const tabPane = document.getElementById(resourceType);
    if (!tabPane) return;
    
    // Find where to insert controls (before the table)
    let tableContainer = tabPane.querySelector('.table-responsive');
    if (!tableContainer) return;
    
    // Create controls container
    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'mb-3 d-flex justify-content-between align-items-center';
    
    // Create search input
    const searchContainer = document.createElement('div');
    searchContainer.className = 'input-group w-50';
    searchContainer.innerHTML = `
        <input type="text" class="form-control" placeholder="Filter ${resourceType}..." id="${resourceType}Search">
        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch('${resourceType}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Create refresh button
    const refreshButton = document.createElement('button');
    refreshButton.className = 'btn btn-primary';
    refreshButton.innerHTML = `<i class="fas fa-sync-alt"></i> Refresh ${capitalizeFirstLetter(resourceType)}`;
    refreshButton.onclick = function() { fetchResourceData(resourceType); };
    
    // Add components to the container
    controlsContainer.appendChild(searchContainer);
    controlsContainer.appendChild(refreshButton);
    
    // Insert controls before the table
    tabPane.insertBefore(controlsContainer, tableContainer);
    
    // Add event listener for search input
    const searchInput = document.getElementById(`${resourceType}Search`);
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterResources(resourceType, this.value);
        });
    }
}

// Capitalize first letter helper (for button labels)
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

// Clear search field and reset table
function clearSearch(resourceType) {
    const searchInput = document.getElementById(`${resourceType}Search`);
    if (searchInput) {
        searchInput.value = '';
        filterResources(resourceType, '');
    }
}

// Filter resources based on search term
function filterResources(resourceType, searchTerm) {
    const tableBody = document.querySelector(`#${resourceType}Table tbody`);
    if (!tableBody) return;
    
    const rows = tableBody.querySelectorAll('tr');
    const searchTermLower = searchTerm.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const shouldShow = searchTerm === '' || text.includes(searchTermLower);
        row.style.display = shouldShow ? '' : 'none';
    });
    
    // Show a message if no results
    let noResultsRow = tableBody.querySelector('.no-results-row');
    
    if (searchTerm !== '' && ![...rows].some(row => row.style.display !== 'none' && !row.classList.contains('no-results-row'))) {
        // No visible rows and search is active
        if (!noResultsRow) {
            noResultsRow = document.createElement('tr');
            noResultsRow.className = 'no-results-row';
            noResultsRow.innerHTML = `<td colspan="7" class="text-center">No ${resourceType} matching "${searchTerm}"</td>`;
            tableBody.appendChild(noResultsRow);
        } else {
            noResultsRow.querySelector('td').textContent = `No ${resourceType} matching "${searchTerm}"`;
            noResultsRow.style.display = '';
        }
    } else if (noResultsRow) {
        // Hide the no results message if there are visible rows or search is cleared
        noResultsRow.style.display = 'none';
    }
}

// Sequential resource fetching with a small delay between each
function fetchResourcesSequentially(resourceTypes, index) {
    if (index >= resourceTypes.length) {
        console.log('All resources loaded successfully');
        return;
    }
    
    const resourceType = resourceTypes[index];
    console.log(`Loading ${resourceType}...`);
    
    fetch('/get_resources', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `resource_type=${resourceType}`
    })
    .then(response => response.json())
    .then(data => {
        const tableBody = document.querySelector(`#${resourceType}Table tbody`);
        if (!tableBody) {
            console.warn(`Table body for ${resourceType} not found`);
            hideLoading(resourceType);
            // Continue to next resource type regardless
            setTimeout(() => fetchResourcesSequentially(resourceTypes, index + 1), 50);
            return;
        }
        
        tableBody.innerHTML = ''; // Clear existing rows
        
        if (data.format === 'error') {
            tableBody.innerHTML = `<tr><td colspan="7">Unable to fetch ${resourceType}</td></tr>`;
            hideLoading(resourceType);
            // Continue to next resource type despite error
            setTimeout(() => fetchResourcesSequentially(resourceTypes, index + 1), 50);
            return;
        }
        
        data.data.items.forEach(item => {
            const row = document.createElement('tr');
            switch (resourceType) {
                case 'pods':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.containerStatuses ? item.status.containerStatuses[0].ready : 'N/A'}</td>
                        <td>${getStatusIcon(item.status.phase)}${item.status.phase}</td>
                        <td>${item.status.containerStatuses ? item.status.containerStatuses[0].restartCount : 'N/A'}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'services':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.spec.type}</td>
                        <td>${item.spec.clusterIP}</td>
                        <td>${item.spec.externalIP || 'N/A'}</td>
                        <td>${item.spec.ports.map(port => `${port.port}/${port.protocol}`).join(', ')}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'inferenceservices':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.url || 'N/A'}</td>
                        <td>${getStatusIcon(item.status.conditions[0].status)}${item.status.conditions[0].status}</td>
                        <td>${item.status.traffic ? item.status.traffic[0].percent : 'N/A'}</td>
                        <td>${item.status.traffic && item.status.traffic.length > 1 ? item.status.traffic[1].percent : 'N/A'}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'deployments':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.readyReplicas || 0}/${item.status.replicas}</td>
                        <td>${item.status.updatedReplicas}</td>
                        <td>${item.status.availableReplicas}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'configmaps':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${Object.keys(item.data || {}).length}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'secrets':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.type}</td>
                        <td>${Object.keys(item.data || {}).length}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
            }
            tableBody.appendChild(row);
        });
        
        hideLoading(resourceType);
        
        // Move to the next resource type after a short delay
        setTimeout(() => fetchResourcesSequentially(resourceTypes, index + 1), 50);
    })
    .catch(error => {
        console.error(`Error fetching ${resourceType}:`, error);
        
        const tableBody = document.querySelector(`#${resourceType}Table tbody`);
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="7">Error fetching ${resourceType}: ${error.message}</td></tr>`;
        }
        
        hideLoading(resourceType);
        
        // Still continue to the next resource type despite errors
        setTimeout(() => fetchResourcesSequentially(resourceTypes, index + 1), 50);
    });
}

// Resource data fetching (for individual tab clicks or refresh button)
function fetchResourceData(resourceType) {
    // Save the current search term before refreshing
    const searchInput = document.getElementById(`${resourceType}Search`);
    const searchTerm = searchInput ? searchInput.value : '';
    
    showLoading(resourceType);
    
    fetch('/get_resources', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `resource_type=${resourceType}`
    })
    .then(response => response.json())
    .then(data => {
        const tableBody = document.querySelector(`#${resourceType}Table tbody`);
        if (!tableBody) {
            console.warn(`Table body for ${resourceType} not found`);
            hideLoading(resourceType);
            return;
        }
        
        tableBody.innerHTML = ''; // Clear existing rows
        
        if (data.format === 'error') {
            tableBody.innerHTML = `<tr><td colspan="7">Unable to fetch ${resourceType}</td></tr>`;
            hideLoading(resourceType);
            return;
        }
        
        data.data.items.forEach(item => {
            const row = document.createElement('tr');
            switch (resourceType) {
                case 'pods':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.containerStatuses ? item.status.containerStatuses[0].ready : 'N/A'}</td>
                        <td>${getStatusIcon(item.status.phase)}${item.status.phase}</td>
                        <td>${item.status.containerStatuses ? item.status.containerStatuses[0].restartCount : 'N/A'}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'services':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.spec.type}</td>
                        <td>${item.spec.clusterIP}</td>
                        <td>${item.spec.externalIP || 'N/A'}</td>
                        <td>${item.spec.ports.map(port => `${port.port}/${port.protocol}`).join(', ')}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'inferenceservices':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.url || 'N/A'}</td>
                        <td>${getStatusIcon(item.status.conditions[0].status)}${item.status.conditions[0].status}</td>
                        <td>${item.status.traffic ? item.status.traffic[0].percent : 'N/A'}</td>
                        <td>${item.status.traffic && item.status.traffic.length > 1 ? item.status.traffic[1].percent : 'N/A'}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'deployments':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.readyReplicas || 0}/${item.status.replicas}</td>
                        <td>${item.status.updatedReplicas}</td>
                        <td>${item.status.availableReplicas}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'configmaps':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${Object.keys(item.data || {}).length}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'secrets':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.type}</td>
                        <td>${Object.keys(item.data || {}).length}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
            }
            tableBody.appendChild(row);
        });
        
        hideLoading(resourceType);
        
        // Reapply search filter after loading new data
        if (searchTerm) {
            filterResources(resourceType, searchTerm);
        }
    })
    .catch(error => {
        console.error(`Error fetching ${resourceType}:`, error);
        hideLoading(resourceType);
        
        const tableBody = document.querySelector(`#${resourceType}Table tbody`);
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="7">Error fetching ${resourceType}: ${error.message}</td></tr>`;
        }
    });
}

// UI helpers
function showLoading(resourceType) {
    const loadingElement = document.getElementById(`${resourceType}Loading`);
    const tableElement = document.getElementById(`${resourceType}Table`);
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (tableElement) tableElement.style.display = 'none';
}

function hideLoading(resourceType) {
    const loadingElement = document.getElementById(`${resourceType}Loading`);
    const tableElement = document.getElementById(`${resourceType}Table`);
    
    if (loadingElement) loadingElement.style.display = 'none';
    if (tableElement) tableElement.style.display = 'block';
}

function createActionButton(resourceType, namespace, name) {
    if (resourceType === 'pods') {
        return `
            <div class="d-flex">
                <a href="#" class="me-2" onclick="runAction('logs', '${resourceType}', '${namespace}', '${name}')" title="View Logs">
                    <i class="fas fa-file-alt text-primary"></i>
                </a>
                <a href="/explore/${namespace}/${name}" class="me-2" title="Explore Pod">
                    <i class="fas fa-terminal text-success"></i>
                </a>
                <a href="#" onclick="runAction('delete', '${resourceType}', '${namespace}', '${name}')" title="Delete">
                    <i class="fas fa-trash-alt text-danger"></i>
                </a>
            </div>
        `;
    } else {
        return `
            <div class="dropdown">
                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="#" onclick="runAction('describe', '${resourceType}', '${namespace}', '${name}')">Describe</a></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('logs', '${resourceType}', '${namespace}', '${name}')">View Logs</a></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('exec', '${resourceType}', '${namespace}', '${name}')">Access</a></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('delete', '${resourceType}', '${namespace}', '${name}')">Delete</a></li>
                </ul>
            </div>
        `;
    }
}

// CLI command execution
function runCliCommand() {
    const command = document.getElementById('cliCommand').value;
    
    // Check if terminal is available
    if (!window.app.terminal) {
        alert('Terminal is not initialized. Please refresh the page and try again.');
        return;
    }
    
    // Check if socket is connected
    if (!window.app.socket) {
        window.app.terminal.write('\r\n\x1b[31mError: Not connected to server. Command could not be sent.\x1b[0m\r\n');
        return;
    }
    
    try {
        window.app.socket.emit('run_cli_command', { command: command });
        window.app.terminal.write(`\r\n$ ${command}\r\n`);
        document.getElementById('cliCommand').value = '';
    } catch (error) {
        console.error('Error sending command:', error);
        window.app.terminal.write(`\r\n\x1b[31mError sending command: ${error.message}\x1b[0m\r\n`);
    }
}

// YAML deployment
function deployYaml() {
    const fileInput = document.querySelector('.drop-zone__input');
    const file = fileInput.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload_yaml', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('yamlOutput').textContent = data.output || data.error;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('yamlOutput').textContent = 'An error occurred while deploying the YAML file.';
        });
    }
}

// Drop zone setup
function setupDropZone() {
    document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
        const dropZoneElement = inputElement.closest(".drop-zone");
        if (!dropZoneElement) return;

        dropZoneElement.addEventListener("click", (e) => {
            inputElement.click();
        });

        inputElement.addEventListener("change", (e) => {
            if (inputElement.files.length) {
                updateThumbnail(dropZoneElement, inputElement.files[0]);
                const deployButton = document.getElementById('deployButton');
                if (deployButton) {
                    deployButton.style.display = 'inline-block';
                }
            }
        });

        dropZoneElement.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZoneElement.classList.add("drop-zone--over");
        });

        ["dragleave", "dragend"].forEach((type) => {
            dropZoneElement.addEventListener(type, (e) => {
                dropZoneElement.classList.remove("drop-zone--over");
            });
        });

        dropZoneElement.addEventListener("drop", (e) => {
            e.preventDefault();

            if (e.dataTransfer.files.length) {
                inputElement.files = e.dataTransfer.files;
                updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
                const deployButton = document.getElementById('deployButton');
                if (deployButton) {
                    deployButton.style.display = 'inline-block';
                }
            }

            dropZoneElement.classList.remove("drop-zone--over");
        });
    });
}

function updateThumbnail(dropZoneElement, file) {
    let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

    if (dropZoneElement.querySelector(".drop-zone__prompt")) {
        dropZoneElement.querySelector(".drop-zone__prompt").remove();
    }

    if (!thumbnailElement) {
        thumbnailElement = document.createElement("div");
        thumbnailElement.classList.add("drop-zone__thumb");
        dropZoneElement.appendChild(thumbnailElement);
    }

    thumbnailElement.dataset.label = file.name;

    if (file.type.startsWith("image/")) {
        const reader = new FileReader();

        reader.readAsDataURL(file);
        reader.onload = () => {
            thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
        };
    } else {
        thumbnailElement.style.backgroundImage = null;
    }
}

// Check git availability
function checkGitAvailability() {
    fetch('/git_status')
    .then(response => response.json())
    .then(data => {
        const githubSettings = document.getElementById('githubSettings');
        if (githubSettings) {
            if (!data.available) {
                githubSettings.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Git functionality is not available.</strong> 
                        <p>The "Update from GitHub" feature requires git to be installed on the server. 
                        Please install git or contact your administrator if you need this feature.</p>
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        console.error('Error checking git status:', error);
    });
}

// Fetch namespaces for events tab
function fetchNamespaces() {
    fetch('/get_namespaces')
        .then(response => response.json())
        .then(data => {
            const namespaceSelect = document.getElementById('namespaceSelect');
            if (!namespaceSelect) return;
            
            namespaceSelect.innerHTML = '<option value="">Select a namespace</option>';
            
            if (data.namespaces) {
                data.namespaces.forEach(namespace => {
                    const option = document.createElement('option');
                    option.value = namespace;
                    option.textContent = namespace;
                    namespaceSelect.appendChild(option);
                });
            } else if (data.error) {
                console.error('Error fetching namespaces:', data.error);
            }
            
            // Set up event listener for namespace selection
            namespaceSelect.addEventListener('change', function() {
                if (this.value) {
                    fetchEvents(this.value);
                }
            });
        })
        .catch(error => {
            console.error('Error fetching namespaces:', error);
        });
}

// Fetch events for selected namespace
function fetchEvents(namespace) {
    const eventsOutput = document.getElementById('eventsOutput');
    if (!eventsOutput) return;
    
    eventsOutput.textContent = 'Loading events...';
    
    fetch('/get_events', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}`
    })
    .then(response => response.json())
    .then(data => {
        eventsOutput.textContent = data.output;
    })
    .catch(error => {
        console.error('Error fetching events:', error);
        eventsOutput.textContent = 'An error occurred while fetching events.';
    });
}

// GitHub update function
function updateFromGithub() {
    const repoUrl = document.getElementById('githubRepo').value;
    const statusDiv = document.getElementById('updateStatus');
    
    if (!statusDiv) return;
    
    statusDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Updating from GitHub...';
    
    // First update from GitHub
    fetch('/update_from_github', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            repo_url: repoUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            statusDiv.innerHTML = 'Update successful. Restarting application...';
            // Then restart the application
            return fetch('/restart', {
                method: 'POST'
            });
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
            throw new Error(data.message);
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            statusDiv.innerHTML = 'Application updated and restarted successfully. Refreshing page...';
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (statusDiv && !statusDiv.innerHTML.includes('alert-danger')) {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });
}

// Application refresh function (for the refresh button)
function refreshApplication() {
    const refreshLog = document.getElementById('refreshLog');
    const statusDiv = document.getElementById('updateStatus');
    
    if (!refreshLog || !statusDiv) {
        console.error('Required elements not found');
        return;
    }
    
    // Clear the log
    refreshLog.innerHTML = '';
    
    // Add initial message
    const logEntry = document.createElement('div');
    logEntry.className = 'text-info';
    logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] Starting refresh process...`;
    refreshLog.appendChild(logEntry);
    
    statusDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Refreshing application...';
    
    // Get the repo URL from the input field
    const repoUrl = document.getElementById('githubRepo').value;
    
    fetch('/refresh_application', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            repo_url: repoUrl || undefined  // Only send if user provided a value
        })
    })
    .catch(error => {
        console.error('Error:', error);
        if (!statusDiv.innerHTML.includes('alert-danger')) {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            
            const errorLogEntry = document.createElement('div');
            errorLogEntry.className = 'text-danger';
            errorLogEntry.innerHTML = `[${new Date().toLocaleTimeString()}] Error: ${error.message}`;
            refreshLog.appendChild(errorLogEntry);
        }
    });
}

// Clear refresh log
function clearRefreshLog() {
    const refreshLog = document.getElementById('refreshLog');
    if (refreshLog) {
        refreshLog.innerHTML = '<div class="text-muted">-- Log will appear here during refresh operations --</div>';
    }
}
</script>
{% endblock %}