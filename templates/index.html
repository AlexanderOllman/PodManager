{% extends "base.html" %}

{% block title %}HPE Private Cloud AI Resource Manager{% endblock %}

{% block additional_styles %}
<style>
    /* Any page-specific styles that aren't included in main.css */
</style>
{% endblock %}

{% block content %}
<div class="tab-content" id="mainContent">
    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Resources Dashboard</h1>
        </div>

        <!-- Metric Cards -->
        <div class="row mb-4">
            <!-- Pods Card -->
            <div class="col-md-3">
                <div class="dashboard-metric-card pods-card">
                    <div class="card-body">
                        <i class="fas fa-cubes card-icon"></i>
                        <h5 class="card-title">Total Pods</h5>
                        <h3 class="counter-value" id="totalPodsCount">-</h3>
                        <div class="metric-details">
                            <div class="metric-item">
                                <i class="fas fa-check-circle running"></i>
                                <div class="value" id="runningPodsCount">-</div>
                                <div class="label">Running</div>
                            </div>
                            <div class="metric-item">
                                <i class="fas fa-flag-checkered succeeded"></i>
                                <div class="value" id="succeededPodsCount">-</div>
                                <div class="label">Succeeded</div>
                            </div>
                            <div class="metric-item">
                                <i class="fas fa-exclamation-circle error"></i>
                                <div class="value" id="errorPodsCount">-</div>
                                <div class="label">Error</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- vCPU Card -->
            <div class="col-md-3">
                <div class="dashboard-metric-card cpu-card">
                    <div class="card-body">
                        <i class="fas fa-microchip card-icon"></i>
                        <h5 class="card-title">vCPU Usage</h5>
                        <h3 class="counter-value" id="totalCPUCount">-</h3>
                        <span class="counter-info"><span id="totalCPUPercentage">-</span>% of <span id="totalCPUCapacity">256</span> Cores</span>
                        <div class="progress mt-2">
                            <div class="progress-bar" id="cpuProgressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GPU Card -->
            <div class="col-md-3">
                <div class="dashboard-metric-card gpu-card" id="gpuCard" role="button">
                    <div class="card-body">
                        <i class="fas fa-tachometer-alt card-icon"></i>
                        <h5 class="card-title">GPU Resources</h5>
                        <h3 class="counter-value" id="totalGPUCount">-</h3>
                        <span class="counter-info d-flex align-items-center">
                            <span id="gpuFilterStatus">Click to filter</span>
                            <button id="clearGPUFilter" class="btn btn-sm btn-outline-secondary ms-2" style="display: none;">Clear</button>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Future Metric Card -->
            <div class="col-md-3">
                <div class="dashboard-metric-card metric-card">
                    <div class="card-body">
                        <i class="fas fa-chart-line card-icon"></i>
                        <h5 class="card-title">Resource Metric</h5>
                        <h3 class="counter-value">-</h3>
                        <span class="counter-info">
                            <i class="fas fa-clock me-1"></i> Coming Soon
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="resourceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pods-tab" data-bs-toggle="tab" data-bs-target="#pods" type="button" role="tab" aria-controls="pods" aria-selected="true">Pods</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab" aria-controls="services" aria-selected="false">Services</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inferenceservices-tab" data-bs-toggle="tab" data-bs-target="#inferenceservices" type="button" role="tab" aria-controls="inferenceservices" aria-selected="false">InferenceServices</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="deployments-tab" data-bs-toggle="tab" data-bs-target="#deployments" type="button" role="tab" aria-controls="deployments" aria-selected="false">Deployments</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="configmaps-tab" data-bs-toggle="tab" data-bs-target="#configmaps" type="button" role="tab" aria-controls="configmaps" aria-selected="false">ConfigMaps</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="secrets-tab" data-bs-toggle="tab" data-bs-target="#secrets" type="button" role="tab" aria-controls="secrets" aria-selected="false">Secrets</button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="resourceTabsContent">
            <div class="tab-pane fade show active" id="pods" role="tabpanel" aria-labelledby="pods-tab">
                <div class="loading-container" id="podsLoading">
                    <div class="progress-container">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="podsProgressBar"></div>
                        </div>
                        <div class="loading-text">Loading Pods...</div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped table-sm border-bottom shadow-sm" id="podsTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0">Namespace</th>
                                <th class="border-0">Name</th>
                                <th class="border-0">Ready</th>
                                <th class="border-0">Status</th>
                                <th class="border-0">vCPU</th>
                                <th class="border-0">GPU</th>
                                <th class="border-0">Memory</th>
                                <th class="border-0">Restarts</th>
                                <th class="border-0">Age</th>
                                <th class="border-0 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="services" role="tabpanel" aria-labelledby="services-tab">
                <div class="loading-container" id="servicesLoading">
                    <div class="progress-container">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="servicesProgressBar"></div>
                        </div>
                        <div class="loading-text">Loading Services...</div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="servicesTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Cluster-IP</th>
                                <th>External-IP</th>
                                <th>Ports</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="inferenceservices" role="tabpanel" aria-labelledby="inferenceservices-tab">
                <div class="loading-container" id="inferenceLoading">
                    <div class="progress-container">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="inferenceProgressBar"></div>
                        </div>
                        <div class="loading-text">Loading Inference Services...</div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="inferenceservicesTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Ready</th>
                                <th>vCPU</th>
                                <th>GPU</th>
                                <th>Memory</th>
                                <th>Default Traffic</th>
                                <th>Canary Traffic</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="deployments" role="tabpanel" aria-labelledby="deployments-tab">
                <div class="loading-container" id="deploymentsLoading">
                    <div class="progress-container">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="deploymentsProgressBar"></div>
                        </div>
                        <div class="loading-text">Loading Deployments...</div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="deploymentsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Ready</th>
                                <th>Up-to-date</th>
                                <th>Available</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="configmaps" role="tabpanel" aria-labelledby="configmaps-tab">
                <div class="loading-container" id="configmapsLoading">
                    <div class="progress-container">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="configmapsProgressBar"></div>
                        </div>
                        <div class="loading-text">Loading Config Maps...</div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="configmapsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Data</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="secrets" role="tabpanel" aria-labelledby="secrets-tab">
                <div class="loading-container" id="secretsLoading">
                    <div class="progress-container">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="secretsProgressBar"></div>
                        </div>
                        <div class="loading-text">Loading Secrets...</div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="secretsTable">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Data</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="cli" role="tabpanel" aria-labelledby="cli-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">CLI Commands</h1>
        </div>
        <div class="alert alert-info mb-3">
            <h5><i class="fas fa-info-circle"></i> Interactive Terminal</h5>
            <p>You can now type directly in the terminal below. Press Enter to execute commands.</p>
            <ul>
                <li>Use <kbd>Up</kbd> and <kbd>Down</kbd> arrow keys to navigate command history</li>
                <li>Commands are executed in the cluster's environment</li>
                <li>The terminal supports standard kubectl commands</li>
            </ul>
        </div>
        <div id="terminal" style="width: 100%; height: 400px; border-radius: 5px; overflow: hidden;"></div>
    </div>
    <div class="tab-pane fade" id="yaml" role="tabpanel" aria-labelledby="yaml-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Upload YAML</h1>
        </div>
        <div class="drop-zone">
            <span class="drop-zone__prompt">Drop YAML file here or click to upload</span>
            <input type="file" name="myFile" class="drop-zone__input" accept=".yaml">
        </div>
        <div class="text-center mt-3">
            <button id="deployButton" class="btn btn-primary" style="display: none;" onclick="deployYaml()">Deploy</button>
        </div>
        <div class="mt-3">
            <pre id="yamlOutput"></pre>
        </div>
    </div>
    <div class="tab-pane fade" id="namespaces" role="tabpanel" aria-labelledby="namespaces-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Kubernetes Namespaces</h1>
        </div>

        <!-- Filters and Controls -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-light border-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-0 bg-light" id="namespaceSearchInput" placeholder="Filter namespaces...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort me-1"></i> Sort By
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item sort-option" href="#" data-sort="name">Name (A-Z)</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="name-desc">Name (Z-A)</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="pods">Pods (High-Low)</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="cpu">vCPU Usage (High-Low)</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="gpu">GPU Usage (High-Low)</a></li>
                        <li><a class="dropdown-item sort-option" href="#" data-sort="memory">Memory Usage (High-Low)</a></li>
                    </ul>
                </div>
                <button type="button" class="btn btn-primary ms-2" id="refreshNamespaces">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Namespaces Loading -->
        <div id="namespacesLoading" class="loading-container">
            <div class="progress-container">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
                <div class="loading-text">Loading namespaces...</div>
            </div>
        </div>

        <!-- Namespaces Table -->
        <div class="card shadow-sm mb-4" id="namespacesTableCard" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="namespacesTable">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th class="text-center">Pods</th>
                            <th class="text-center">vCPU Usage</th>
                            <th class="text-center">GPU Usage</th>
                            <th class="text-center">Memory Usage</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="namespacesTableBody">
                        <!-- Table will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Results Message -->
        <div id="noNamespacesMessage" class="text-center py-5" style="display: none;">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5>No namespaces found</h5>
            <p class="text-muted">Try adjusting your search or filter settings</p>
        </div>
    </div>

    <!-- Namespace Edit Modal -->
    <div class="modal fade" id="namespaceEditModal" tabindex="-1" aria-labelledby="namespaceEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="namespaceModalLabel">Namespace: <span id="namespaceModalName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="namespaceTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="namespacePods-tab" data-bs-toggle="tab" data-bs-target="#namespacePods" type="button" role="tab" aria-controls="namespacePods" aria-selected="false">Pods</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="namespaceEvents-tab" data-bs-toggle="tab" data-bs-target="#namespaceEvents" type="button" role="tab" aria-controls="namespaceEvents" aria-selected="false">Events</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="namespaceDescribe-tab" data-bs-toggle="tab" data-bs-target="#namespaceDescribe" type="button" role="tab" aria-controls="namespaceDescribe" aria-selected="false">Describe</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="namespaceEdit-tab" data-bs-toggle="tab" data-bs-target="#namespaceEdit" type="button" role="tab" aria-controls="namespaceEdit" aria-selected="false">Edit</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="namespaceDelete-tab" data-bs-toggle="tab" data-bs-target="#namespaceDelete" type="button" role="tab" aria-controls="namespaceDelete" aria-selected="false">Delete</button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content py-3" id="namespaceTabContent">
                        <!-- Pods Tab -->
                        <div class="tab-pane fade" id="namespacePods" role="tabpanel" aria-labelledby="namespacePods-tab">
                            <div class="d-flex justify-content-center my-3 namespace-pod-loader">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div class="namespace-pods-content" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Status</th>
                                                <th>CPU</th>
                                                <th>Memory</th>
                                                <th>GPUs</th>
                                                <th>Age</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="namespacePodsList">
                                            <!-- Pods will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Events Tab -->
                        <div class="tab-pane fade" id="namespaceEvents" role="tabpanel" aria-labelledby="namespaceEvents-tab">
                            <div class="d-flex justify-content-center my-3 namespace-events-loader">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <pre class="namespace-events-output" style="display: none;"></pre>
                        </div>

                        <!-- Describe Tab -->
                        <div class="tab-pane fade" id="namespaceDescribe" role="tabpanel" aria-labelledby="namespaceDescribe-tab">
                            <div class="d-flex justify-content-center my-3 namespace-describe-loader">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <pre class="namespace-describe-output" style="display: none;"></pre>
                        </div>

                        <!-- Edit Tab -->
                        <div class="tab-pane fade" id="namespaceEdit" role="tabpanel" aria-labelledby="namespaceEdit-tab">
                            <div class="d-flex justify-content-center my-3 namespace-edit-loader">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div class="namespace-edit-content" style="display: none;">
                                <form id="editNamespaceForm">
                                    <div class="mb-3">
                                        <label for="editNamespaceName" class="form-label">Name</label>
                                        <input type="text" class="form-control" id="editNamespaceName" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editNamespaceLabels" class="form-label">Labels</label>
                                        <textarea class="form-control" id="editNamespaceLabels" rows="3"></textarea>
                                        <div class="form-text">Format: key1=value1,key2=value2</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Update</button>
                                </form>
                            </div>
                        </div>

                        <!-- Delete Tab -->
                        <div class="tab-pane fade" id="namespaceDelete" role="tabpanel" aria-labelledby="namespaceDelete-tab">
                            <div class="alert alert-danger mt-3">
                                <strong>Warning!</strong> This action cannot be undone. To confirm deletion, please type the namespace name below.
                            </div>
                            <div class="mb-3">
                                <label for="deleteNamespaceConfirm" class="form-label">Type the namespace name to confirm:</label>
                                <input type="text" class="form-control" id="deleteNamespaceConfirm">
                            </div>
                            <button id="deleteNamespaceButton" class="btn btn-danger" disabled>Delete Namespace</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNamespaceChanges" style="display: none;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab Content -->
    <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h2>Settings</h2>
        </div>
        
        <div id="githubSettings">
            <div class="mb-3">
                <label for="githubRepo" class="form-label">GitHub Repository URL:</label>
                <input type="text" class="form-control" id="githubRepo" placeholder="https://github.com/username/repo">
            </div>
            <button class="btn btn-primary" onclick="updateFromGithub()">Update from GitHub</button>
            
            <!-- New Refresh Button Section -->
            <div class="mt-4 border-top pt-3">
                <h4>Application Refresh</h4>
                <p class="text-muted">
                    This will stop the application, perform a hard pull on the GitHub repository, 
                    and restart the application with the latest code.
                </p>
                <button class="btn btn-warning" onclick="refreshApplication()">
                    <i class="fas fa-sync-alt"></i> Refresh Application
                </button>
            </div>
            
            <!-- Log Display Area -->
            <div class="mt-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Refresh Log</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearRefreshLog()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="refreshLog" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                            <div class="text-muted">-- Log will appear here during refresh operations --</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="updateStatus" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
// Main initialization function that runs when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM content loaded, initializing application...');
    
    // Check if we're on the Charts page based on URL
    if (window.location.pathname.includes('/charts')) {
        console.log('Charts page URL detected, setting isChartsPage flag');
        window.isChartsPage = true;
        return; // Skip further initialization
    } else {
        window.isChartsPage = false;
    }
    
    // Since scripts are loaded in head, we can initialize right away
    initializeApp();
    
    // Add page visibility change detection for better navigation handling
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible' && !window.isChartsPage) {
            console.log('Page is now visible, checking resource loading state...');
            // Check if any tab content is visible but not loaded
            try {
                const activeTabId = document.querySelector('.tab-pane.active')?.id;
                if (activeTabId && ['pods', 'services', 'inferenceservices', 'deployments', 'configmaps', 'secrets'].includes(activeTabId)) {
                    if (!window.loadedResources || !window.loadedResources[activeTabId]) {
                        console.log(`Active tab ${activeTabId} not loaded, fetching data...`);
                        fetchResourceData(activeTabId);
                    }
                }
            } catch (e) {
                console.error('Error checking visible tab state:', e);
            }
        }
    });
    
    // Handle browser navigation (back/forward) events
    window.onpopstate = function(event) {
        console.log('Navigation state change detected');
        
        // If we're back on the home page
        if (window.location.pathname === '/' || window.location.pathname === '') {
            const activeTabId = document.querySelector('.tab-pane.active')?.id;
            
            // Check if the active tab is a resource tab that should load data
            if (activeTabId && ['pods', 'services', 'inferenceservices', 'deployments', 'configmaps', 'secrets'].includes(activeTabId)) {
                console.log(`Navigation returned to home page, loading ${activeTabId} data`);
                
                // Force reload for the active tab
                if (window.loadedResources) {
                    window.loadedResources[activeTabId] = false;
                }
                
                // Load the active tab data
                fetchResourceData(activeTabId);
            }
        }
        
        // Apply state if it exists
        if (event.state) {
            document.getElementById('main-content').innerHTML = event.state.content;
            
            // Re-initialize components if needed
            if (event.state.page === 'home') {
                if (typeof initializeHomePage === 'function') {
                    initializeHomePage();
                }
                
                // Make sure the active tab data is loaded
                const activeTabId = document.querySelector('.tab-pane.active')?.id;
                if (activeTabId && ['pods', 'services', 'inferenceservices', 'deployments', 'configmaps', 'secrets'].includes(activeTabId)) {
                    fetchResourceData(activeTabId);
                }
            } else if (event.state.page === 'explore' && typeof initializeExplorePage === 'function') {
                initializeExplorePage();
            }
        }
    };
});

// Main application initialization
function initializeApp() {
    console.log('Initializing application...');
    
    // Check if we're on the Charts page
    if (window.isChartsPage === true) {
        console.log('Charts page detected, skipping home page initialization');
        return;
    }
    
    // Initialize components that don't require special dependencies
    fetchResourcesForAllTabs();
    fetchClusterCapacity(); // Add this line to fetch cluster capacity on initialization
    checkGitAvailability();
    fetchNamespaces();
    setupDropZone();
    
    // Initialize terminal if available
    initializeTerminal();
    
    // Connect socket event listeners
    connectSocketListeners();
    
    // Set up additional tab click handlers
    setupTabClickHandlers();
    
    console.log('Application initialized');
}

// Home page specific initialization
function initializeHomePage() {
    console.log('Initializing home page components...');
    
    // Initialize GPU filter card
    initializeGPUFilter();
    
    // Add controls to each resource tab
    const resourceTypes = ['pods', 'services', 'inferenceservices', 'deployments', 'configmaps', 'secrets'];
    resourceTypes.forEach(resourceType => {
        addResourceControls(resourceType);
        
        // Set up tab click handlers to load data on demand
        const tabElement = document.querySelector(`#${resourceType}-tab`);
        if (tabElement) {
            tabElement.addEventListener('click', () => {
                // Only fetch data if not already loaded
                if (!window.loadedResources || !window.loadedResources[resourceType]) {
                    fetchResourceData(resourceType);
                }
            });
        }
    });
    
    // Load the active tab content
    const activeTabId = document.querySelector('.tab-pane.active')?.id;
    if (activeTabId && resourceTypes.includes(activeTabId)) {
        fetchResourceData(activeTabId);
    } else {
        // If no tab is active, load pods as default
        fetchResourceData('pods');
    }
}

// Terminal initialization - already loaded in head
function initializeTerminal() {
    if (document.getElementById('terminal')) {
        try {
            console.log('Initializing terminal...');
            
            // Create terminal with FitAddon for proper sizing
            const terminal = new Terminal({
                cursorBlink: true,
                fontFamily: 'monospace',
                fontSize: 14,
                convertEol: true,
                scrollback: 1000,
                theme: {
                    background: '#000000',
                    foreground: '#ffffff'
                }
            });
            
            // Store terminal in global state
            window.app.terminal = terminal;
            
            // Open terminal
            terminal.open(document.getElementById('terminal'));
            
            // Setup command input handling
            let currentLine = '';
            let commandHistory = [];
            let historyIndex = -1;
            
            // Initial prompt
            terminal.writeln('Welcome to the Kubernetes CLI.');
            terminal.writeln('Type commands directly in this window and press Enter to execute.');
            terminal.writeln('');
            terminal.write('$ ');
            
            // Handle user input
            terminal.onKey(({ key, domEvent }) => {
                const printable = !domEvent.altKey && !domEvent.altGraphKey && !domEvent.ctrlKey && !domEvent.metaKey;
                
                // Handle special keys
                if (domEvent.keyCode === 13) { // Enter key
                    // Send command to server
                    if (currentLine.trim()) {
                        // Add to history
                        commandHistory.push(currentLine);
                        historyIndex = commandHistory.length;
                        
                        // Execute command via REST API
                        executeCliCommand(currentLine);
                        
                        // Visual feedback
                        terminal.write('\r\n');
                        currentLine = '';
                    } else {
                        // Empty command, just show new prompt
                        terminal.write('\r\n$ ');
                    }
                } else if (domEvent.keyCode === 8) { // Backspace
                    if (currentLine.length > 0) {
                        currentLine = currentLine.slice(0, -1);
                        terminal.write('\b \b'); // Erase character
                    }
                } else if (domEvent.keyCode === 38) { // Up arrow - history
                    if (historyIndex > 0) {
                        historyIndex--;
                        // Clear current line
                        terminal.write('\r$ ' + ' '.repeat(currentLine.length) + '\r$ ');
                        // Display command from history
                        currentLine = commandHistory[historyIndex];
                        terminal.write(currentLine);
                    }
                } else if (domEvent.keyCode === 40) { // Down arrow - history
                    if (historyIndex < commandHistory.length - 1) {
                        historyIndex++;
                        // Clear current line
                        terminal.write('\r$ ' + ' '.repeat(currentLine.length) + '\r$ ');
                        // Display next command from history
                        currentLine = commandHistory[historyIndex];
                        terminal.write(currentLine);
                    } else if (historyIndex === commandHistory.length - 1) {
                        historyIndex = commandHistory.length;
                        // Clear current line
                        terminal.write('\r$ ' + ' '.repeat(currentLine.length) + '\r$ ');
                        currentLine = '';
                    }
                } else if (printable) {
                    // Regular printable character
                    currentLine += key;
                    terminal.write(key);
                }
            });
            
            console.log('Terminal initialized successfully with REST mode');
        } catch (error) {
            console.error('Failed to initialize terminal:', error);
            const terminalElement = document.getElementById('terminal');
            terminalElement.innerHTML = '<div class="alert alert-danger">Failed to initialize terminal: ' + error.message + '</div>';
        }
    }
}

// Function to execute commands via REST API
function executeCliCommand(command) {
    if (!command) return;
    
    fetch('/api/cli/exec', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            command: command
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.output) {
            window.app.terminal.writeln(data.output);
        } else {
            window.app.terminal.writeln('Command executed with no output.');
        }
        window.app.terminal.write('\r\n$ ');
    })
    .catch(error => {
        console.error('Error:', error);
        window.app.terminal.writeln('Error executing command.');
        window.app.terminal.write('\r\n$ ');
    });
}

// Socket event listeners
function connectSocketListeners() {
    const socket = window.app.socket;
    if (!socket) {
        console.warn('Socket not available for event listeners');
        return;
    }
    
    // Refresh log listener for the settings page
    const refreshLog = document.getElementById('refreshLog');
    if (refreshLog) {
        socket.on('refresh_log', function(data) {
            const logMessage = data.message;
            
            // Create new log entry with appropriate class based on status
            const logEntry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            // Set class based on status
            if (data.status === 'error') {
                logEntry.className = 'text-danger';
            } else if (data.status === 'warning') {
                logEntry.className = 'text-warning';
            } else if (data.status === 'success') {
                logEntry.className = 'text-success';
            } else {
                logEntry.className = 'text-info';
            }
            
            logEntry.innerHTML = `[${timestamp}] ${logMessage}`;
            refreshLog.appendChild(logEntry);
            
            // Auto-scroll to the bottom
            refreshLog.scrollTop = refreshLog.scrollHeight;
            
            // If this is a completion message, trigger the restart
            if (logMessage.includes('Preparing to restart application')) {
                // Wait a moment to ensure the user sees the restart message
                setTimeout(() => {
                    fetch('/restart', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const statusDiv = document.getElementById('updateStatus');
                        if (data.status === 'success') {
                            const logEntry = document.createElement('div');
                            logEntry.className = 'text-success';
                            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] Application restarted successfully. Page will refresh shortly...`;
                            refreshLog.appendChild(logEntry);
                            
                            statusDiv.innerHTML = 'Application restarted successfully. Refreshing page...';
                            setTimeout(() => {
                                window.location.reload();
                            }, 3000);
                        }
                    });
                }, 1000);
            }
        });
    }
}

// Fetch all resources for each tab (line 882)
function fetchResourcesForAllTabs() {
    // Skip if already run
    if (window.resourcesTabsInitialized) {
        console.log('Resource tabs already initialized, skipping duplicate initialization');
        return;
    }
    
    console.log('Setting up resource tabs and loading initial data...');
    
    // Skip this function on the Charts page
    if (window.isChartsPage === true) {
        console.log('Charts page detected, skipping resource tab initialization');
        return;
    }
    
    // Define supported resource types
    const resourceTypes = ['pods', 'services', 'inferenceservices', 'deployments', 'configmaps', 'secrets'];
    
    // Initialize loadedResources tracking object if not already created
    window.loadedResources = window.loadedResources || {};
    
    // Setup for each resource type
    resourceTypes.forEach(resourceType => {
        showLoading(resourceType);
        
        // Add refresh button and search bar to each resource tab
        addResourceControls(resourceType);
        
        // Set up tab click handlers to load data on demand
        const tabElement = document.querySelector(`#${resourceType}-tab`);
        if (tabElement) {
            tabElement.addEventListener('click', () => {
                // Only fetch data if not already loaded
                if (!window.loadedResources[resourceType]) {
                    fetchResourceData(resourceType);
                }
            });
        }
    });
    
    // Only load the active tab initially
    const activeTabId = document.querySelector('.tab-pane.active').id;
    if (activeTabId && resourceTypes.includes(activeTabId)) {
        fetchResourceData(activeTabId);
    } else {
        // If no tab is active, load pods as default
        fetchResourceData('pods');
    }
    
    // Set up a failsafe to check if the resources loaded correctly
    setTimeout(() => {
        const activeTabId = document.querySelector('.tab-pane.active').id;
        if (activeTabId && resourceTypes.includes(activeTabId)) {
            const tableBody = document.querySelector(`#${activeTabId}Table tbody`);
            if (tableBody && (tableBody.children.length === 0 || !window.loadedResources[activeTabId])) {
                console.log(`No data found in ${activeTabId} after initial load, retrying...`);
                fetchResourceData(activeTabId);
            }
        }
    }, 5000);
    
    // Mark as initialized
    window.resourcesTabsInitialized = true;
}

// Add refresh button and search bar to each resource tab
function addResourceControls(resourceType) {
    // Store a global flag to prevent multiple calls creating duplicates
    window.resourceControlsCreated = window.resourceControlsCreated || {};
    
    // Skip if already created for this resource type
    if (window.resourceControlsCreated[resourceType]) {
        console.log(`Controls already exist for ${resourceType}, skipping creation`);
        return;
    }
    
    const tabPane = document.getElementById(resourceType);
    if (!tabPane) return;
    
    // Find existing controls to avoid duplicates
    const existingControls = tabPane.querySelector('.resource-controls-container');
    if (existingControls) {
        console.log(`Controls already exist in DOM for ${resourceType}, skipping creation`);
        window.resourceControlsCreated[resourceType] = true;
        return;
    }
    
    // Find where to insert controls (before the table)
    let tableContainer = tabPane.querySelector('.table-responsive');
    if (!tableContainer) return;
    
    // Create controls container
    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'mb-3 d-flex justify-content-between align-items-center resource-controls-container';
    
    // Create search input
    const searchContainer = document.createElement('div');
    searchContainer.className = 'input-group w-50';
    searchContainer.innerHTML = `
        <input type="text" class="form-control" placeholder="Filter ${resourceType}..." id="${resourceType}Search">
        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch('${resourceType}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Create refresh button
    const refreshButton = document.createElement('button');
    refreshButton.className = 'btn btn-primary';
    refreshButton.innerHTML = `<i class="fas fa-sync-alt"></i> Refresh ${capitalizeFirstLetter(resourceType)}`;
    refreshButton.onclick = function() { 
        // Force refresh by clearing the cached data
        if (window.loadedResources) {
            delete window.loadedResources[resourceType];
        }
        fetchResourceData(resourceType); 
    };
    
    // Add components to the container
    controlsContainer.appendChild(searchContainer);
    controlsContainer.appendChild(refreshButton);
    
    // Insert controls before the table
    tableContainer.parentNode.insertBefore(controlsContainer, tableContainer);
    
    // Mark as created
    window.resourceControlsCreated[resourceType] = true;
    
    // Add event listener for search input
    const searchInput = document.getElementById(`${resourceType}Search`);
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterResources(resourceType, this.value);
        });
    }
}

// Capitalize first letter helper (for button labels)
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

// Clear search field and reset table
function clearSearch(resourceType) {
    const searchInput = document.getElementById(`${resourceType}Search`);
    if (searchInput) {
        searchInput.value = '';
        filterResources(resourceType, '');
    }
}

// Filter resources based on search term
function filterResources(resourceType, searchTerm) {
    const tableBody = document.querySelector(`#${resourceType}Table tbody`);
    if (!tableBody) return;
    
    const rows = tableBody.querySelectorAll('tr');
    const searchTermLower = searchTerm.toLowerCase();
    
    // Check if GPU filter is active
    const isGPUFilterActive = document.getElementById('gpuCard')?.classList.contains('filter-active');
    // Use gpuPodNames from the window object, falling back to podsWithGPUs if needed
    const gpuPodNames = window.gpuPodNames || 
                         (window.podsWithGPUs?.map(pod => `${pod.namespace}/${pod.name}`)) || [];
    
    rows.forEach(row => {
        if (row.classList.contains('no-results-row') || row.classList.contains('no-gpu-pods-row')) {
            row.style.display = 'none';
            return;
        }
        
        const text = row.textContent.toLowerCase();
        const matchesSearch = searchTerm === '' || text.includes(searchTermLower);
        
        // If GPU filter is active, also check if this pod has GPUs
        if (isGPUFilterActive && resourceType === 'pods') {
            const namespace = row.cells[0]?.textContent;
            const name = row.cells[1]?.textContent;
            const hasGPU = gpuPodNames.includes(`${namespace}/${name}`);
            
            row.style.display = (matchesSearch && hasGPU) ? '' : 'none';
        } else {
            row.style.display = matchesSearch ? '' : 'none';
        }
    });
    
    // Show a message if no results
    let noResultsRow = tableBody.querySelector('.no-results-row');
    
    if (searchTerm !== '' && ![...rows].some(row => row.style.display !== 'none' && 
        !row.classList.contains('no-results-row') && 
        !row.classList.contains('no-gpu-pods-row'))) {
        // No visible rows and search is active
        if (!noResultsRow) {
            noResultsRow = document.createElement('tr');
            noResultsRow.className = 'no-results-row';
            const colspan = resourceType === 'pods' ? 10 : 
                           (resourceType === 'inferenceservices' ? 11 : 7);
            noResultsRow.innerHTML = `<td colspan="${colspan}" class="text-center">No ${resourceType} matching "${searchTerm}"${isGPUFilterActive ? ' with GPU resources' : ''}</td>`;
            tableBody.appendChild(noResultsRow);
        } else {
            noResultsRow.querySelector('td').textContent = `No ${resourceType} matching "${searchTerm}"${isGPUFilterActive ? ' with GPU resources' : ''}`;
            noResultsRow.style.display = '';
        }
    } else if (noResultsRow) {
        // Hide the no results message if there are visible rows or search is cleared
        noResultsRow.style.display = 'none';
    }
    
    // If GPU filter is active but no pods are found, show GPU filter message
    if (isGPUFilterActive && resourceType === 'pods' && 
        ![...rows].some(row => row.style.display !== 'none' && 
            !row.classList.contains('no-results-row') && 
            !row.classList.contains('no-gpu-pods-row'))) {
        showNoGPUPodsMessage();
    }
}

// Resource data fetching (for individual tab clicks or refresh button)
function fetchResourceData(resourceType) {
    console.log(`Fetching ${resourceType} data...`);
    
    // Save the current search term before refreshing
    const searchInput = document.getElementById(`${resourceType}Search`);
    const searchTerm = searchInput ? searchInput.value : '';
    
    showLoading(resourceType);
    
    // Update progress text based on resource type
    const loadingText = document.querySelector(`#${resourceType}Loading .loading-text`);
    if (loadingText) {
        loadingText.textContent = `Loading ${capitalizeFirstLetter(resourceType)}...`;
    }
    
    // Update progress bar to indicate request is sent
    const progressBar = document.getElementById(`${resourceType}ProgressBar`);
    if (progressBar) {
        progressBar.style.width = '20%';
    }
    
    fetch('/get_resources', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `resource_type=${resourceType}`
    })
    .then(response => {
        // Update progress bar to indicate response received
        if (progressBar) {
            progressBar.style.width = '70%';
        }
        
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        // Update progress bar to indicate processing data
        if (progressBar) {
            progressBar.style.width = '90%';
        }
        
        const tableBody = document.querySelector(`#${resourceType}Table tbody`);
        if (!tableBody) {
            console.warn(`Table body for ${resourceType} not found`);
            hideLoading(resourceType);
            return;
        }
        
        tableBody.innerHTML = ''; // Clear existing rows
        
        if (data.format === 'error') {
            tableBody.innerHTML = `<tr><td colspan="10">Unable to fetch ${resourceType}: ${data.message}</td></tr>`;
            hideLoading(resourceType);
            return;
        }
        
        // For empty results, show a message
        if (!data.data.items || data.data.items.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="10" class="text-center">No ${resourceType} found</td></tr>`;
            hideLoading(resourceType);
            return;
        }
        
        // Store pods data for later use
        if (resourceType === 'pods') {
            window.podsData = data.data.items;
            updateDashboardMetrics(data.data.items);
        }
        
        data.data.items.forEach(item => {
            const row = document.createElement('tr');
            switch (resourceType) {
                case 'pods':
                    const resources = getResourceUsage(item);
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.containerStatuses ? item.status.containerStatuses[0].ready : 'N/A'}</td>
                        <td>${getStatusIcon(item.status.phase)}${item.status.phase}</td>
                        <td class="resource-cell cpu-cell"><i class="fas fa-microchip me-1"></i>${resources.cpu || '0'}</td>
                        <td class="resource-cell gpu-cell"><i class="fas fa-tachometer-alt me-1"></i>${resources.gpu || '0'}</td>
                        <td class="resource-cell memory-cell"><i class="fas fa-memory me-1"></i>${resources.memory || '0Mi'}</td>
                        <td>${item.status.containerStatuses ? item.status.containerStatuses[0].restartCount : 'N/A'}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'services':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.spec.type}</td>
                        <td>${item.spec.clusterIP}</td>
                        <td>${item.spec.externalIP || 'N/A'}</td>
                        <td>${item.spec.ports.map(port => `${port.port}/${port.protocol}`).join(', ')}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'inferenceservices':
                    // For InferenceServices, get resources from spec.predictor
                    let infResources = { cpu: '0', gpu: '0', memory: '0Mi' };
                    if (item.spec && item.spec.predictor) {
                        if (item.spec.predictor.tensorflow || item.spec.predictor.triton || 
                            item.spec.predictor.pytorch || item.spec.predictor.sklearn || 
                            item.spec.predictor.xgboost || item.spec.predictor.custom) {
                            // Get the appropriate predictor implementation
                            const predictorImpl = item.spec.predictor.tensorflow || item.spec.predictor.triton || 
                                                 item.spec.predictor.pytorch || item.spec.predictor.sklearn || 
                                                 item.spec.predictor.xgboost || item.spec.predictor.custom;
                            
                            if (predictorImpl.resources) {
                                if (predictorImpl.resources.requests) {
                                    // CPU
                                    if (predictorImpl.resources.requests.cpu) {
                                        const cpuReq = predictorImpl.resources.requests.cpu;
                                        if (cpuReq.endsWith('m')) {
                                            infResources.cpu = (parseInt(cpuReq.slice(0, -1)) / 1000).toFixed(2);
                                        } else {
                                            infResources.cpu = parseFloat(cpuReq).toFixed(2);
                                        }
                                    }
                                    
                                    // GPU
                                    if (predictorImpl.resources.requests['nvidia.com/gpu']) {
                                        infResources.gpu = predictorImpl.resources.requests['nvidia.com/gpu'];
                                    } else if (predictorImpl.resources.requests.gpu) {
                                        infResources.gpu = predictorImpl.resources.requests.gpu;
                                    }
                                    
                                    // Memory
                                    if (predictorImpl.resources.requests.memory) {
                                        infResources.memory = predictorImpl.resources.requests.memory;
                                    }
                                }
                            }
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.url || 'N/A'}</td>
                        <td>${getStatusIcon(item.status.conditions[0].status)}${item.status.conditions[0].status}</td>
                        <td class="resource-cell cpu-cell"><i class="fas fa-microchip me-1"></i>${infResources.cpu}</td>
                        <td class="resource-cell gpu-cell"><i class="fas fa-tachometer-alt me-1"></i>${infResources.gpu}</td>
                        <td class="resource-cell memory-cell"><i class="fas fa-memory me-1"></i>${infResources.memory}</td>
                        <td>${item.status.traffic ? item.status.traffic[0].percent : 'N/A'}</td>
                        <td>${item.status.traffic && item.status.traffic.length > 1 ? item.status.traffic[1].percent : 'N/A'}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'deployments':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.status.readyReplicas || 0}/${item.status.replicas}</td>
                        <td>${item.status.updatedReplicas}</td>
                        <td>${item.status.availableReplicas}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'configmaps':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${Object.keys(item.data || {}).length}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
                case 'secrets':
                    row.innerHTML = `
                        <td>${item.metadata.namespace}</td>
                        <td>${item.metadata.name}</td>
                        <td>${item.type}</td>
                        <td>${Object.keys(item.data || {}).length}</td>
                        <td>${new Date(item.metadata.creationTimestamp).toLocaleString()}</td>
                        <td>${createActionButton(resourceType, item.metadata.namespace, item.metadata.name)}</td>
                    `;
                    break;
            }
            tableBody.appendChild(row);
        });
        
        hideLoading(resourceType);
        
        // Mark this resource type as loaded
        window.loadedResources = window.loadedResources || {};
        window.loadedResources[resourceType] = true;
        
        // Reapply search filter after loading new data
        if (searchTerm) {
            filterResources(resourceType, searchTerm);
        }
        
        console.log(`${resourceType} data loaded successfully`);
    })
    .catch(error => {
        console.error(`Error fetching ${resourceType}:`, error);
        hideLoading(resourceType);
        
        const tableBody = document.querySelector(`#${resourceType}Table tbody`);
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">
                <i class="fas fa-exclamation-triangle"></i> Error fetching ${resourceType}: ${error.message}
            </td></tr>`;
        }
    });
}

// UI helpers
function showLoading(resourceType) {
    const loadingElement = document.getElementById(`${resourceType}Loading`);
    const tableElement = document.getElementById(`${resourceType}Table`);
    const progressBar = document.getElementById(`${resourceType}ProgressBar`);
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (tableElement) tableElement.style.display = 'none';
    
    // Animate progress bar
    if (progressBar) {
        progressBar.style.width = '0%';
        setTimeout(() => {
            progressBar.style.width = '40%';
            
            // This simulates the progress advancing in stages
            setTimeout(() => {
                progressBar.style.width = '65%';
            }, 300);
        }, 100);
    }
}

function hideLoading(resourceType) {
    const loadingElement = document.getElementById(`${resourceType}Loading`);
    const tableElement = document.getElementById(`${resourceType}Table`);
    const progressBar = document.getElementById(`${resourceType}ProgressBar`);
    
    // Complete the progress bar animation
    if (progressBar) {
        progressBar.style.width = '100%';
        
        // Short delay to show the completed progress before hiding
        setTimeout(() => {
            if (loadingElement) loadingElement.style.display = 'none';
            if (tableElement) tableElement.style.display = 'block';
        }, 200);
    } else {
        if (loadingElement) loadingElement.style.display = 'none';
        if (tableElement) tableElement.style.display = 'block';
    }
}

function createActionButton(resourceType, namespace, name) {
    if (resourceType === 'pods') {
        return `
            <div class="action-dropdown dropdown text-center">
                <button class="dropdown-toggle" type="button" id="dropdown-${namespace}-${name}" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-${namespace}-${name}">
                    <li><a class="dropdown-item" href="#" onclick="runAction('describe', '${resourceType}', '${namespace}', '${name}')">
                        <i class="fas fa-info-circle text-info"></i> Describe
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('logs', '${resourceType}', '${namespace}', '${name}')">
                        <i class="fas fa-file-alt text-primary"></i> View Logs
                    </a></li>
                    <li><a class="dropdown-item explore-pod-link" href="/explore/${namespace}/${name}" data-namespace="${namespace}" data-pod-name="${name}">
                        <i class="fas fa-terminal text-success"></i> Explore Pod
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('delete', '${resourceType}', '${namespace}', '${name}')">
                        <i class="fas fa-trash-alt text-danger"></i> Delete
                    </a></li>
                </ul>
            </div>
        `;
    } else {
        return `
            <div class="action-dropdown dropdown text-center">
                <button class="dropdown-toggle" type="button" id="dropdown-${namespace}-${name}" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-${namespace}-${name}">
                    <li><a class="dropdown-item" href="#" onclick="runAction('describe', '${resourceType}', '${namespace}', '${name}')">
                        <i class="fas fa-info-circle text-info"></i> Describe
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="runAction('delete', '${resourceType}', '${namespace}', '${name}')">
                        <i class="fas fa-trash-alt text-danger"></i> Delete
                    </a></li>
                </ul>
            </div>
        `;
    }
}

// CLI command execution - no longer needed as we type directly in terminal
function runCliCommand() {
    // For backward compatibility with any buttons that might still call this
    const command = document.getElementById('cliCommand');
    
    if (command && command.value) {
        const cmd = command.value.trim();
        if (cmd) {
            // Use the new function instead of socket
            executeCliCommand(cmd);
            command.value = '';
        }
    }
}

// YAML deployment
function deployYaml() {
    const fileInput = document.querySelector('.drop-zone__input');
    const file = fileInput.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload_yaml', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('yamlOutput').textContent = data.output || data.error;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('yamlOutput').textContent = 'An error occurred while deploying the YAML file.';
        });
    }
}

// Drop zone setup
function setupDropZone() {
    document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
        const dropZoneElement = inputElement.closest(".drop-zone");
        if (!dropZoneElement) return;

        dropZoneElement.addEventListener("click", (e) => {
            inputElement.click();
        });

        inputElement.addEventListener("change", (e) => {
            if (inputElement.files.length) {
                updateThumbnail(dropZoneElement, inputElement.files[0]);
                const deployButton = document.getElementById('deployButton');
                if (deployButton) {
                    deployButton.style.display = 'inline-block';
                }
            }
        });

        dropZoneElement.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZoneElement.classList.add("drop-zone--over");
        });

        ["dragleave", "dragend"].forEach((type) => {
            dropZoneElement.addEventListener(type, (e) => {
                dropZoneElement.classList.remove("drop-zone--over");
            });
        });

        dropZoneElement.addEventListener("drop", (e) => {
            e.preventDefault();

            if (e.dataTransfer.files.length) {
                inputElement.files = e.dataTransfer.files;
                updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
                const deployButton = document.getElementById('deployButton');
                if (deployButton) {
                    deployButton.style.display = 'inline-block';
                }
            }

            dropZoneElement.classList.remove("drop-zone--over");
        });
    });
}

function updateThumbnail(dropZoneElement, file) {
    let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

    if (dropZoneElement.querySelector(".drop-zone__prompt")) {
        dropZoneElement.querySelector(".drop-zone__prompt").remove();
    }

    if (!thumbnailElement) {
        thumbnailElement = document.createElement("div");
        thumbnailElement.classList.add("drop-zone__thumb");
        dropZoneElement.appendChild(thumbnailElement);
    }

    thumbnailElement.dataset.label = file.name;

    if (file.type.startsWith("image/")) {
        const reader = new FileReader();

        reader.readAsDataURL(file);
        reader.onload = () => {
            thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
        };
    } else {
        thumbnailElement.style.backgroundImage = null;
    }
}

// Check git availability
function checkGitAvailability() {
    fetch('/git_status')
    .then(response => response.json())
    .then(data => {
        const githubSettings = document.getElementById('githubSettings');
        if (githubSettings) {
        if (!data.available) {
            githubSettings.innerHTML = `
                <div class="alert alert-warning">
                    <strong>Git functionality is not available.</strong> 
                    <p>The "Update from GitHub" feature requires git to be installed on the server. 
                    Please install git or contact your administrator if you need this feature.</p>
                </div>
            `;
            }
        }
    })
    .catch(error => {
        console.error('Error checking git status:', error);
    });
}

// Fetch namespaces for events tab
function fetchNamespaces() {
    fetch('/get_namespaces')
        .then(response => response.json())
        .then(data => {
            const namespaceSelect = document.getElementById('namespaceSelect');
            if (!namespaceSelect) return;
            
            namespaceSelect.innerHTML = '<option value="">Select a namespace</option>';
            
            if (data.namespaces) {
                data.namespaces.forEach(namespace => {
                    const option = document.createElement('option');
                    option.value = namespace;
                    option.textContent = namespace;
                    namespaceSelect.appendChild(option);
                });
            } else if (data.error) {
                console.error('Error fetching namespaces:', data.error);
            }
            
            // Set up event listener for namespace selection
            namespaceSelect.addEventListener('change', function() {
                if (this.value) {
                    fetchEvents(this.value);
                }
            });
        })
        .catch(error => {
            console.error('Error fetching namespaces:', error);
        });
}

// Fetch events for selected namespace
function fetchEvents(namespace) {
    const eventsOutput = document.getElementById('eventsOutput');
    if (!eventsOutput) return;
    
    eventsOutput.textContent = 'Loading events...';
    
    fetch('/get_events', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}`
    })
    .then(response => response.json())
    .then(data => {
        eventsOutput.textContent = data.output;
    })
    .catch(error => {
        console.error('Error fetching events:', error);
        eventsOutput.textContent = 'An error occurred while fetching events.';
    });
}

// GitHub update function
function updateFromGithub() {
    const repoUrl = document.getElementById('githubRepo').value;
    const statusDiv = document.getElementById('updateStatus');
    
    if (!statusDiv) return;
    
    statusDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Updating from GitHub...';
    
    // First update from GitHub
    fetch('/update_from_github', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            repo_url: repoUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            statusDiv.innerHTML = 'Update successful. Initiating application restart...';
            
            // Then restart the application
            fetch('/restart', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.innerHTML = 'Application restart initiated. Waiting for application to come back online...';
                    waitForApplicationRestart(statusDiv);
                }
            })
            .catch(error => {
                if (error.message !== 'restart_in_progress') {
                    console.error('Error during restart:', error);
                    statusDiv.innerHTML = `<div class="alert alert-warning">Restart initiated, but couldn't confirm status. Will try to reconnect.</div>`;
                    waitForApplicationRestart(statusDiv);
                }
            });
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
            throw new Error(data.message);
        }
    })
    .catch(error => {
        if (error.message !== 'restart_in_progress') {
            console.error('Error:', error);
            if (statusDiv && !statusDiv.innerHTML.includes('alert-danger')) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
    });
}

// Application refresh function (for the refresh button)
function refreshApplication() {
    const refreshLog = document.getElementById('refreshLog');
    const statusDiv = document.getElementById('updateStatus');
    
    if (!refreshLog || !statusDiv) {
        console.error('Required elements not found');
        return;
    }
    
    // Clear the log
    refreshLog.innerHTML = '';
    
    // Add initial message
    const logEntry = document.createElement('div');
    logEntry.className = 'text-info';
    logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] Starting refresh process...`;
    refreshLog.appendChild(logEntry);
    
    statusDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Refreshing application...';
    
    fetch('/refresh_application', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            repo_url: document.getElementById('githubRepo').value || undefined  // Only send if user provided a value
        })
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            // If the request fails, it might be because the app is already restarting
            logMessage(refreshLog, 'Application restart initiated. Waiting for server to come back online...', 'info');
            statusDiv.innerHTML = 'Application is restarting. Waiting for it to come back online...';
            waitForApplicationRestart(statusDiv, refreshLog);
            throw new Error('restart_in_progress');
        }
    })
    .then(data => {
        if (data && data.status === 'success') {
            logMessage(refreshLog, 'Refresh operation successful, application restart initiated.', 'success');
            statusDiv.innerHTML = 'Application is restarting. Waiting for it to come back online...';
            waitForApplicationRestart(statusDiv, refreshLog);
        } else if (data && data.error) {
            logMessage(refreshLog, `Error: ${data.error}`, 'error');
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        if (error.message !== 'restart_in_progress') {
            console.error('Error:', error);
            logMessage(refreshLog, `Error: ${error.message}`, 'error');
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });
}

// Helper to add log messages to the refresh log
function logMessage(refreshLog, message, status) {
    if (!refreshLog) return;
    
    const logEntry = document.createElement('div');
    const timestamp = new Date().toLocaleTimeString();
    
    // Set class based on status
    if (status === 'error') {
        logEntry.className = 'text-danger';
    } else if (status === 'warning') {
        logEntry.className = 'text-warning';
    } else if (status === 'success') {
        logEntry.className = 'text-success';
    } else {
        logEntry.className = 'text-info';
    }
    
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    refreshLog.appendChild(logEntry);
    
    // Auto-scroll to the bottom
    refreshLog.scrollTop = refreshLog.scrollHeight;
}

// Function to poll and wait for application to restart
function waitForApplicationRestart(statusDiv, refreshLog = null) {
    const MAX_ATTEMPTS = 30; // Try for up to 30 seconds
    let attempts = 0;
    
    // Update UI to show we're waiting
    if (statusDiv) {
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Waiting for application to restart...
                </div>
                <div class="progress mt-2" style="height: 5px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        `;
    }
    
    if (refreshLog) {
        logMessage(refreshLog, "Application is restarting. Waiting for it to come back online...", "info");
    }
    
    // Set up polling
    const checkServer = function() {
        attempts++;
        
        // Update progress bar
        if (statusDiv) {
            const progressBar = statusDiv.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${Math.min((attempts / MAX_ATTEMPTS) * 100, 100)}%`;
            }
        }
        
        // Try a lightweight request to check if server is back
        fetch('/health_check', { 
            method: 'GET',
            // Add cache-busting to prevent cached responses
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        })
        .then(response => {
            if (response.ok) {
                // Server is back online!
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> Application restarted successfully!
                        </div>
                    `;
                }
                
                if (refreshLog) {
                    logMessage(refreshLog, "Application is back online! Refreshing page in 3 seconds...", "success");
                }
                
                // Refresh the page after a short delay to let the user see the success message
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                // Server responded but with an error
                if (attempts < MAX_ATTEMPTS) {
                    setTimeout(checkServer, 1000);
                } else {
                    handleTimeout();
                }
            }
        })
        .catch(error => {
            // Server is still down, or network error
            if (attempts < MAX_ATTEMPTS) {
                setTimeout(checkServer, 1000);
            } else {
                handleTimeout();
            }
        });
    };
    
    // Function to handle timeout case
    const handleTimeout = function() {
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> The application is taking longer than expected to restart.
                    <button class="btn btn-sm btn-primary mt-2" onclick="window.location.reload()">
                        Refresh Now
                    </button>
                </div>
            `;
        }
        
        if (refreshLog) {
            logMessage(refreshLog, "Application is taking longer than expected to restart. You may need to refresh manually.", "warning");
        }
    };
    
    // Start polling after a short delay to allow the server to begin restarting
    setTimeout(checkServer, 2000);
}

// Clear refresh log
function clearRefreshLog() {
    const refreshLog = document.getElementById('refreshLog');
    if (refreshLog) {
        refreshLog.innerHTML = '<div class="text-muted">-- Log will appear here during refresh operations --</div>';
    }
}

// Filter to show only pods with GPUs
function filterPodsWithGPUs() {
    if (!window.podsWithGPUs) return;
    
    const podRows = document.querySelectorAll('#podsTable tbody tr');
    const gpuPodNames = window.podsWithGPUs.map(pod => `${pod.namespace}/${pod.name}`);
    
    podRows.forEach(row => {
        const namespace = row.cells[0]?.textContent;
        const name = row.cells[1]?.textContent;
        
        if (gpuPodNames.includes(`${namespace}/${name}`)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Check if any rows are visible
    const anyVisible = Array.from(podRows).some(row => row.style.display !== 'none');
    if (!anyVisible) {
        showNoGPUPodsMessage();
    }
}

// Show a message when no GPU pods are found
function showNoGPUPodsMessage() {
    const tableBody = document.querySelector('#podsTable tbody');
    if (!tableBody) return;
    
    // Check if message already exists
    let noGPURow = tableBody.querySelector('.no-gpu-pods-row');
    
    if (!noGPURow) {
        noGPURow = document.createElement('tr');
        noGPURow.className = 'no-gpu-pods-row';
        noGPURow.innerHTML = `
            <td colspan="10" class="text-center">
                <div class="alert alert-info m-3">
                    <i class="fas fa-info-circle me-2"></i> No pods with GPU resources found.
                    <button class="btn btn-sm btn-outline-primary ms-3" onclick="clearGPUFilter()">
                        Clear Filter
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(noGPURow);
    } else {
        noGPURow.style.display = '';
    }
}

// Clear GPU filter directly (for use in the "Clear Filter" button)
function clearGPUFilter() {
    const gpuCard = document.getElementById('gpuCard');
    const gpuFilterStatus = document.getElementById('gpuFilterStatus');
    
    gpuCard.classList.remove('filter-active');
    gpuFilterStatus.textContent = 'Click to filter by GPU';
    
    // Show all pod rows
    const podRows = document.querySelectorAll('#podsTable tbody tr');
    podRows.forEach(row => {
        row.style.display = '';
    });
    
    // Hide the no-gpu-pods message if it exists
    const noGPURow = document.querySelector('.no-gpu-pods-row');
    if (noGPURow) {
        noGPURow.style.display = 'none';
    }
}

// Navigation function to handle explore pod links
document.addEventListener('click', function(e) {
    // Use delegation to handle clicks on explore pod links
    const exploreLink = e.target.closest('.explore-pod-link');
    if (exploreLink) {
        e.preventDefault();
        const namespace = exploreLink.dataset.namespace;
        const podName = exploreLink.dataset.podName;
        const url = `/explore/${namespace}/${podName}`;
        
        console.log(`Navigating to pod explorer: ${url}`);
        
        // Navigate to the explore page using full page navigation
        window.location.href = url;
    }
});

// Set up tab click handlers for GPU filter persistence
function setupTabClickHandlers() {
    const resourceTabs = document.querySelectorAll('#resourceTabs .nav-link');
    
    resourceTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target').substring(1); // Remove the # prefix
            
            // If we're switching to pods tab and GPU filter was active, reapply filter
            if (targetId === 'pods') {
                // Check in a small timeout to allow the tab to become active
                setTimeout(() => {
                    const isGPUFilterActive = document.getElementById('gpuCard')?.classList.contains('filter-active');
                    if (isGPUFilterActive) {
                        filterPodsWithGPUs();
                    }
                }, 100);
            }
        });
    });
}

// Helper function to calculate resource usage
function getResourceUsage(item) {
    let cpu = 0;
    let gpu = 0;
    let memory = '0';
    
    // Function to convert memory to standardized format (Mi)
    function standardizeMemory(memStr) {
        if (!memStr) return '0Mi';
        
        // Remove any whitespace
        memStr = memStr.trim();
        
        // Check if memory is in Ki format
        if (memStr.endsWith('Ki')) {
            const valueInKi = parseFloat(memStr.slice(0, -2));
            return (valueInKi / 1024).toFixed(1) + 'Mi';
        }
        
        // Check if memory is in Mi format
        if (memStr.endsWith('Mi')) {
            return memStr;
        }
        
        // Check if memory is in Gi format
        if (memStr.endsWith('Gi')) {
            const valueInGi = parseFloat(memStr.slice(0, -2));
            return (valueInGi * 1024).toFixed(0) + 'Mi';
        }
        
        // Check if memory is in bytes (no unit)
        if (!isNaN(memStr)) {
            const valueInBytes = parseFloat(memStr);
            return (valueInBytes / (1024 * 1024)).toFixed(1) + 'Mi';
        }
        
        // Default case: just return the original string
        return memStr;
    }
    
    // If this is a pod, extract resource data from containers
    if (item.spec && item.spec.containers) {
        item.spec.containers.forEach(container => {
            if (container.resources && container.resources.requests) {
                // Add CPU requests if available
                if (container.resources.requests.cpu) {
                    const cpuRequest = container.resources.requests.cpu;
                    if (cpuRequest.endsWith('m')) {
                        // Convert millicpu to CPU
                        cpu += parseInt(cpuRequest.slice(0, -1)) / 1000;
                    } else {
                        // Direct CPU value
                        cpu += parseFloat(cpuRequest);
                    }
                }
                
                // Add GPU resources if available
                if (container.resources.requests['nvidia.com/gpu']) {
                    gpu += parseInt(container.resources.requests['nvidia.com/gpu']);
                } else if (container.resources.requests['gpu']) {
                    gpu += parseInt(container.resources.requests['gpu']);
                }
                
                // Add memory requests if available
                if (container.resources.requests.memory) {
                    const memRequest = standardizeMemory(container.resources.requests.memory);
                    // Extract numeric value from memory string
                    const memValue = parseFloat(memRequest);
                    memory = memValue + 'Mi';
                }
            }
        });
    }
    
    return {
        cpu: cpu.toFixed(2),
        gpu: gpu.toString(),
        memory: memory
    };
}

// Helper function to get status icon based on phase
function getStatusIcon(phase) {
    if (!phase) return '';
    
    phase = phase.toLowerCase();
    switch (phase) {
        case 'running':
        case 'true':
            return '<i class="fas fa-check-circle text-success me-1"></i>';
        case 'succeeded':
            return '<i class="fas fa-check-square text-primary me-1"></i>';
        case 'pending':
            return '<i class="fas fa-clock text-warning me-1"></i>';
        case 'failed':
        case 'false':
            return '<i class="fas fa-times-circle text-danger me-1"></i>';
        case 'unknown':
            return '<i class="fas fa-question-circle text-muted me-1"></i>';
        default:
            return '<i class="fas fa-info-circle text-info me-1"></i>';
    }
}

// Add this new function to fetch cluster capacity
function fetchClusterCapacity() {
    console.log('Fetching cluster capacity metrics...');
    
    // Store default values in case API call fails
    window.clusterCapacity = {
        cpu: 256, // Default fallback value
        memory: 1024, // in Gi
        gpu: 0
    };
    
    fetch('/get_cluster_capacity')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to fetch cluster capacity: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.cpu) {
                window.clusterCapacity.cpu = data.cpu;
            }
            if (data.memory) {
                window.clusterCapacity.memory = data.memory;
            }
            if (data.gpu !== undefined) {
                window.clusterCapacity.gpu = data.gpu;
            }
            
            console.log(`Cluster capacity loaded: ${window.clusterCapacity.cpu} CPU cores, ${window.clusterCapacity.memory} Gi memory, ${window.clusterCapacity.gpu} GPUs`);
            
            // Update capacity display in the UI
            document.getElementById('totalCPUCapacity').textContent = window.clusterCapacity.cpu;
            
            // If we already have pod data, recalculate the metrics with the new capacity
            if (window.loadedResources && window.loadedResources.pods) {
                const tableBody = document.querySelector('#podsTable tbody');
                if (tableBody) {
                    const pods = window.podsData || [];
                    if (pods.length > 0) {
                        updateDashboardMetrics(pods);
                    }
                }
            }
        })
        .catch(error => {
            console.warn(`Error fetching cluster capacity: ${error.message}. Using default values.`);
        });
}

// Namespaces functionality
$(document).ready(function() {
    // Initialize namespaces tab
    $('a[data-bs-toggle="tab"][data-bs-target="#namespaces"]').on('shown.bs.tab', function (e) {
        loadNamespaces();
    });

    // Refresh namespaces button
    $('#refreshNamespaces').on('click', function() {
        loadNamespaces();
    });

    // Filter namespaces
    $('#namespaceSearchInput').on('keyup', function() {
        filterNamespaces();
    });

    // Sort namespaces
    $('.sort-option').on('click', function(e) {
        e.preventDefault();
        const sortBy = $(this).data('sort');
        sortNamespaces(sortBy);
    });

    // Handle namespace actions
    $(document).on('click', '.namespace-action', function(e) {
        e.preventDefault();
        const action = $(this).data('action');
        const namespace = $(this).data('namespace');
        
        // Set the current namespace for the modal
        $('#namespaceModalName').text(namespace);
        $('#currentNamespaceName').text(namespace);
        
        if (action === 'pods') {
            openNamespaceModal(namespace, 'pods');
        } else if (action === 'events') {
            openNamespaceModal(namespace, 'events');
        } else if (action === 'describe') {
            openNamespaceModal(namespace, 'describe');
        } else if (action === 'edit') {
            openNamespaceModal(namespace, 'edit');
        } else if (action === 'delete') {
            openNamespaceModal(namespace, 'delete');
            $('#deleteNamespaceConfirm').val('');
            $('#deleteNamespaceButton').prop('disabled', true);
        }
    });

    // Save namespace changes
    $('#saveNamespaceChanges').on('click', function() {
        saveNamespaceChanges();
    });

    // Handle namespace delete confirmation input
    $('#namespaceDeleteConfirm').on('input', function() {
        const inputValue = $(this).val();
        const namespaceName = $('#currentNamespaceName').text();
        
        if (inputValue === namespaceName) {
            $('#confirmNamespaceDelete').prop('disabled', false);
        } else {
            $('#confirmNamespaceDelete').prop('disabled', true);
        }
    });
    
    // Handle namespace delete button
    $('#confirmNamespaceDelete').on('click', function() {
        deleteNamespace();
    });

    // Switch tabs in namespace modal
    $('#namespaceDetailTabs button').on('shown.bs.tab', function (e) {
        const tabId = $(e.target).attr('id');
        if (tabId === 'edit-tab') {
            $('#saveNamespaceChanges').show();
        } else {
            $('#saveNamespaceChanges').hide();
        }
    });
});

// Load namespaces data
function loadNamespaces() {
    // Show loading indicator
    $('#namespacesLoading').show();
    $('#namespacesTableCard').hide();
    $('#noNamespacesMessage').hide();

    // Fetch namespaces data
    $.ajax({
        url: '/get_namespace_details',
        type: 'GET',
        success: function(response) {
            if (response.hasOwnProperty('namespaces')) {
                // Store the namespaces data for filtering/sorting
                window.namespacesData = response.namespaces;
                
                // Render the namespaces
                renderNamespaces(window.namespacesData);
            } else {
                showNoNamespaces('Error loading namespaces');
            }
        },
        error: function() {
            showNoNamespaces('Failed to fetch namespaces data');
        },
        complete: function() {
            $('#namespacesLoading').hide();
        }
    });
}

// Render namespaces table
function renderNamespaces(namespaces) {
    const tableBody = $('#namespacesTableBody');
    tableBody.empty();

    if (namespaces.length === 0) {
        showNoNamespaces();
        return;
    }

    namespaces.forEach(function(ns) {
        const row = $('<tr>');
        
        // Name column
        row.append(`<td>
            <div class="d-flex align-items-center">
                <div class="avatar-sm rounded bg-info me-3">
                    <span class="avatar-title rounded">
                        <i class="fas fa-project-diagram text-white"></i>
                    </span>
                </div>
                <div>
                    <h6 class="mb-0">${ns.name}</h6>
                    <small class="text-muted">${getCreationTime(ns)}</small>
                </div>
            </div>
        </td>`);
        
        // Pod count column
        row.append(`<td class="text-center">
            <span class="fw-bold">${ns.podCount}</span>
        </td>`);
        
        // vCPU usage column
        row.append(`<td class="text-center resource-cell cpu-cell">
            <span class="fw-bold">${ns.resources.cpu}</span> vCPUs
        </td>`);
        
        // GPU usage column
        row.append(`<td class="text-center resource-cell gpu-cell">
            <span class="fw-bold">${ns.resources.gpu}</span> GPUs
        </td>`);
        
        // Memory usage column
        row.append(`<td class="text-center resource-cell memory-cell">
            <span class="fw-bold">${ns.resources.memory}</span> MB
        </td>`);
        
        // Status column
        const status = getNamespaceStatus(ns);
        row.append(`<td class="text-center">
            <span class="badge bg-${status.color}">${status.text}</span>
        </td>`);
        
        // Actions column
        row.append(`<td class="text-center">
            <div class="dropdown action-dropdown">
                <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item namespace-action" href="#" data-action="pods" data-namespace="${ns.name}">
                        <i class="fas fa-cubes text-success"></i> View Pods
                    </a></li>
                    <li><a class="dropdown-item namespace-action" href="#" data-action="events" data-namespace="${ns.name}">
                        <i class="fas fa-clock text-info"></i> Events
                    </a></li>
                    <li><a class="dropdown-item namespace-action" href="#" data-action="describe" data-namespace="${ns.name}">
                        <i class="fas fa-info-circle text-primary"></i> Describe
                    </a></li>
                    <li><a class="dropdown-item namespace-action" href="#" data-action="edit" data-namespace="${ns.name}">
                        <i class="fas fa-edit text-warning"></i> Edit
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item namespace-action" href="#" data-action="delete" data-namespace="${ns.name}">
                        <i class="fas fa-trash-alt text-danger"></i> Delete
                    </a></li>
                </ul>
            </div>
        </td>`);
        
        tableBody.append(row);
    });

    $('#namespacesTableCard').show();
}

// Filter namespaces based on search input
function filterNamespaces() {
    const searchTerm = $('#namespaceSearchInput').val().toLowerCase();
    
    if (!window.namespacesData) return;
    
    const filteredNamespaces = window.namespacesData.filter(function(ns) {
        return ns.name.toLowerCase().includes(searchTerm);
    });
    
    renderNamespaces(filteredNamespaces);
}

// Sort namespaces based on selected option
function sortNamespaces(sortBy) {
    if (!window.namespacesData) return;
    
    const sortedNamespaces = [...window.namespacesData];
    
    switch (sortBy) {
        case 'name':
            sortedNamespaces.sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'name-desc':
            sortedNamespaces.sort((a, b) => b.name.localeCompare(a.name));
            break;
        case 'pods':
            sortedNamespaces.sort((a, b) => b.podCount - a.podCount);
            break;
        case 'cpu':
            sortedNamespaces.sort((a, b) => b.resources.cpu - a.resources.cpu);
            break;
        case 'gpu':
            sortedNamespaces.sort((a, b) => b.resources.gpu - a.resources.gpu);
            break;
        case 'memory':
            sortedNamespaces.sort((a, b) => b.resources.memory - a.resources.memory);
            break;
        default:
            break;
    }
    
    renderNamespaces(sortedNamespaces);
}

// Show message when no namespaces are found
function showNoNamespaces(message = 'No namespaces found') {
    $('#namespacesTableCard').hide();
    $('#noNamespacesMessage').show();
    $('#noNamespacesMessage h5').text(message);
}

// Get namespace creation time
function getCreationTime(namespace) {
    if (namespace.metadata && namespace.metadata.creationTimestamp) {
        const date = new Date(namespace.metadata.creationTimestamp);
        return `Created ${date.toLocaleDateString()}`;
    }
    return '';
}

// Get namespace status
function getNamespaceStatus(namespace) {
    if (namespace.metadata && namespace.metadata.status && namespace.metadata.status.phase) {
        const phase = namespace.metadata.status.phase;
        switch (phase) {
            case 'Active':
                return { text: 'Active', color: 'success' };
            case 'Terminating':
                return { text: 'Terminating', color: 'warning' };
            default:
                return { text: phase, color: 'secondary' };
        }
    }
    // Default to active if status not found
    return { text: 'Active', color: 'success' };
}

// Open namespace modal with specified tab
function openNamespaceModal(namespace, initialTab = 'pods') {
    // Set current namespace
    $('#namespaceModalName').text(namespace);
    $('#currentNamespaceName').text(namespace);
    
    // Reset delete confirmation input
    $('#deleteNamespaceConfirm').val('');
    $('#deleteNamespaceButton').prop('disabled', true);
    
    // Show loading indicators and hide content
    $('.namespace-pod-loader, .namespace-events-loader, .namespace-describe-loader, .namespace-edit-loader').show();
    $('.namespace-pods-content, .namespace-events-output, .namespace-describe-output, .namespace-edit-content').hide();
    
    // Show the modal
    $('#namespaceEditModal').modal('show');
    
    // Activate the correct tab
    if (initialTab === 'pods') {
        $('#namespacePods-tab').tab('show');
        loadNamespacePods(namespace);
    } else if (initialTab === 'events') {
        $('#namespaceEvents-tab').tab('show');
        loadNamespaceEvents(namespace);
    } else if (initialTab === 'describe') {
        $('#namespaceDescribe-tab').tab('show');
        loadNamespaceDescribe(namespace);
    } else if (initialTab === 'edit') {
        $('#namespaceEdit-tab').tab('show');
        loadNamespaceEdit(namespace);
    } else if (initialTab === 'delete') {
        $('#namespaceDelete-tab').tab('show');
    }
}

// Function to load namespace pods
function loadNamespacePods(namespace) {
    $('.namespace-pod-loader').show();
    $('.namespace-pods-content').hide();
    
    $.ajax({
        url: '/api/pods',
        method: 'GET',
        data: { namespace: namespace },
        success: function(data) {
            let podList = $('#namespacePodsList');
            podList.empty();
            
            if (data.pods && data.pods.length > 0) {
                data.pods.forEach(pod => {
                    let gpuCount = pod.gpu_count || 0;
                    let gpuCell = gpuCount > 0 ? 
                        `<span class="badge bg-success">${gpuCount}</span>` : 
                        '<span class="text-muted">0</span>';
                    
                    let statusClass = 'bg-secondary';
                    if (pod.status === 'Running') {
                        statusClass = 'bg-success';
                    } else if (pod.status === 'Pending') {
                        statusClass = 'bg-warning';
                    } else if (pod.status === 'Failed' || pod.status === 'Unknown') {
                        statusClass = 'bg-danger';
                    }
                    
                    let row = $(`
                        <tr>
                            <td>${pod.name}</td>
                            <td><span class="badge ${statusClass}">${pod.status}</span></td>
                            <td>${pod.cpu || 'N/A'}</td>
                            <td>${pod.memory || 'N/A'}</td>
                            <td class="text-center">${gpuCell}</td>
                            <td>${pod.age || 'N/A'}</td>
                            <td class="text-center">
                                <div class="dropdown action-dropdown">
                                    <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item pod-action" href="#" data-action="logs" data-pod="${pod.name}" data-namespace="${namespace}">
                                            <i class="fas fa-file-alt text-info"></i> Logs
                                        </a></li>
                                        <li><a class="dropdown-item pod-action" href="#" data-action="describe" data-pod="${pod.name}" data-namespace="${namespace}">
                                            <i class="fas fa-info-circle text-primary"></i> Describe
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item pod-action" href="#" data-action="delete" data-pod="${pod.name}" data-namespace="${namespace}">
                                            <i class="fas fa-trash-alt text-danger"></i> Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    `);
                    podList.append(row);
                });
            } else {
                podList.append('<tr><td colspan="7" class="text-center">No pods found in this namespace</td></tr>');
            }
            
            $('.namespace-pod-loader').hide();
            $('.namespace-pods-content').show();
        },
        error: function(xhr) {
            $('#namespacePodsList').html('<tr><td colspan="7" class="text-center text-danger">Error loading pods: ' + 
                (xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Unknown error') + '</td></tr>');
            $('.namespace-pod-loader').hide();
            $('.namespace-pods-content').show();
        }
    });
}

// Function to load namespace events
function loadNamespaceEvents(namespace) {
    $('.namespace-events-loader').show();
    $('.namespace-events-output').hide();
    
    $.ajax({
        url: '/api/namespaces/' + namespace + '/events',
        method: 'GET',
        success: function(data) {
            $('.namespace-events-output').text(data.events || 'No events found for this namespace.');
            $('.namespace-events-loader').hide();
            $('.namespace-events-output').show();
        },
        error: function(xhr) {
            $('.namespace-events-output').text('Error loading events: ' + 
                (xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Unknown error'));
            $('.namespace-events-loader').hide();
            $('.namespace-events-output').show();
        }
    });
}

// Function to load namespace describe data
function loadNamespaceDescribe(namespace) {
    $('.namespace-describe-loader').show();
    $('.namespace-describe-output').hide();
    
    $.ajax({
        url: '/api/namespaces/' + namespace + '/describe',
        method: 'GET',
        success: function(data) {
            $('.namespace-describe-output').text(data.description || 'No description available for this namespace.');
            $('.namespace-describe-loader').hide();
            $('.namespace-describe-output').show();
        },
        error: function(xhr) {
            $('.namespace-describe-output').text('Error loading description: ' + 
                (xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Unknown error'));
            $('.namespace-describe-loader').hide();
            $('.namespace-describe-output').show();
        }
    });
}

// Function to load namespace edit data
function loadNamespaceEdit(namespace) {
    $('.namespace-edit-loader').show();
    $('.namespace-edit-content').hide();
    
    $.ajax({
        url: '/api/namespaces/' + namespace,
        method: 'GET',
        success: function(data) {
            $('#editNamespaceName').val(data.name || namespace);
            
            // Format labels as key=value pairs for display
            let labelsText = '';
            if (data.labels && Object.keys(data.labels).length > 0) {
                labelsText = Object.entries(data.labels)
                    .map(([key, value]) => `${key}=${value}`)
                    .join(',');
            }
            $('#editNamespaceLabels').val(labelsText);
            
            $('.namespace-edit-loader').hide();
            $('.namespace-edit-content').show();
        },
        error: function(xhr) {
            alert('Error loading namespace data: ' + 
                (xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Unknown error'));
            $('.namespace-edit-loader').hide();
        }
    });
}

// Handle tab changes to load data when needed
$('#namespaceTabs button').on('click', function (e) {
    e.preventDefault();
    const tabId = $(this).attr('id');
    const namespace = $('#namespaceModalName').text();
    
    if (tabId === 'namespacePods-tab') {
        loadNamespacePods(namespace);
    } else if (tabId === 'namespaceEvents-tab') {
        loadNamespaceEvents(namespace);
    } else if (tabId === 'namespaceDescribe-tab') {
        loadNamespaceDescribe(namespace);
    } else if (tabId === 'namespaceEdit-tab') {
        loadNamespaceEdit(namespace);
    }
    
    $(this).tab('show');
});

// Delete namespace
function deleteNamespace() {
    const namespace = $('#currentNamespaceName').text();
    
    // Show confirmation dialog
    if (!confirm(`Are you ABSOLUTELY SURE you want to delete the namespace "${namespace}" and ALL resources within it? This action CANNOT be undone!`)) {
        return;
    }
    
    // Disable the delete button and show a loading message
    $('#confirmNamespaceDelete').prop('disabled', true);
    $('#confirmNamespaceDelete').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');
    
    $.ajax({
        url: '/api/namespace/delete',
        type: 'POST',
        data: { namespace: namespace },
        success: function(response) {
            if (response.hasOwnProperty('output')) {
                alert(`Namespace "${namespace}" has been deleted.`);
                // Close the modal and refresh the namespaces list
                $('#namespaceEditModal').modal('hide');
                loadNamespaces();
            } else {
                alert('Error: ' + response.error);
                // Re-enable the delete button
                $('#confirmNamespaceDelete').prop('disabled', false);
                $('#confirmNamespaceDelete').html('<i class="fas fa-trash-alt me-2"></i> Permanently Delete Namespace');
            }
        },
        error: function() {
            alert('Failed to delete namespace. Please try again.');
            // Re-enable the delete button
            $('#confirmNamespaceDelete').prop('disabled', false);
            $('#confirmNamespaceDelete').html('<i class="fas fa-trash-alt me-2"></i> Permanently Delete Namespace');
        }
    });
}

// Save namespace changes
function saveNamespaceChanges() {
    const namespace = $('#currentNamespaceName').text();
    const yaml = $('#namespaceYamlEditor').val();
    
    // Show loading
    $('#namespaceEditContent').hide();
    $('#namespaceEditLoading').show();
    
    $.ajax({
        url: '/api/namespace/update',
        type: 'POST',
        data: { 
            namespace: namespace,
            yaml: yaml
        },
        success: function(response) {
            if (response.hasOwnProperty('output')) {
                // Show success message
                alert('Namespace updated successfully.');
                
                // Refresh the data
                loadNamespaceEdit(namespace);
                loadNamespaceDescribe(namespace);
                loadNamespaces();
            } else {
                alert('Error: ' + response.error);
                $('#namespaceEditContent').show();
            }
        },
        error: function() {
            alert('Failed to update namespace. Please try again.');
            $('#namespaceEditContent').show();
        },
        complete: function() {
            $('#namespaceEditLoading').hide();
        }
    });
}

// Dashboard Metrics Functions
function updateDashboardMetrics(pods) {
    console.log('Updating dashboard metrics with data from', pods.length, 'pods');
    
    // Count all pods
    const totalPods = pods.length;
    
    // Count pods by status (correctly accessing the status phase)
    const runningPods = pods.filter(pod => pod.status && pod.status.phase && pod.status.phase.toLowerCase() === 'running').length;
    const succeededPods = pods.filter(pod => pod.status && pod.status.phase && pod.status.phase.toLowerCase() === 'succeeded').length;
    const errorPods = pods.filter(pod => {
        if (!pod.status || !pod.status.phase) return false;
        const phase = pod.status.phase.toLowerCase();
        return phase === 'failed' || phase === 'error' || phase === 'unknown' || 
            // Check for container statuses with specific error conditions
            (pod.status.containerStatuses && pod.status.containerStatuses.some(status => 
                status.state && (
                    (status.state.waiting && ['crashloopbackoff', 'error', 'errimagepull', 'imagepullbackoff', 'createcontainererror'].includes(status.state.waiting.reason?.toLowerCase())) ||
                    (status.state.terminated && status.state.terminated.exitCode !== 0)
                )
            ));
    }).length;
    
    // Update the UI
    document.getElementById('totalPodsCount').textContent = totalPods;
    document.getElementById('runningPodsCount').textContent = runningPods;
    document.getElementById('succeededPodsCount').textContent = succeededPods;
    document.getElementById('errorPodsCount').textContent = errorPods;
    
    // Calculate and display CPU usage
    const totalCPURequest = pods.reduce((total, pod) => {
        // Get CPU from each container in the pod
        if (pod.spec && pod.spec.containers) {
            pod.spec.containers.forEach(container => {
                if (container.resources && container.resources.requests && container.resources.requests.cpu) {
                    const cpuRequest = container.resources.requests.cpu;
                    if (cpuRequest.endsWith('m')) {
                        // Convert millicpu to CPU
                        total += parseInt(cpuRequest.slice(0, -1)) / 1000;
                    } else {
                        // Direct CPU value
                        total += parseFloat(cpuRequest);
                    }
                }
            });
        }
        return total;
    }, 0);
    
    // For debugging
    console.log(`Total CPU request: ${totalCPURequest.toFixed(1)} cores`);
    console.log(`Cluster capacity: ${window.clusterCapacity ? window.clusterCapacity.cpu : 'unknown'} cores`);
    
    const cpuPercentage = window.clusterCapacity && window.clusterCapacity.cpu ? 
        Math.round((totalCPURequest / window.clusterCapacity.cpu) * 100) : 0;
    
    document.getElementById('totalCPUCount').textContent = totalCPURequest.toFixed(1);
    document.getElementById('totalCPUPercentage').textContent = cpuPercentage;
    
    // Update CPU progress bar
    const cpuProgressBar = document.getElementById('cpuProgressBar');
    if (cpuProgressBar) {
        cpuProgressBar.style.width = `${cpuPercentage}%`;
        
        // Change color based on usage
        if (cpuPercentage > 90) {
            cpuProgressBar.className = 'progress-bar bg-danger';
        } else if (cpuPercentage > 75) {
            cpuProgressBar.className = 'progress-bar bg-warning';
        } else {
            cpuProgressBar.className = 'progress-bar';
        }
    }
    
    // Count GPU resources
    const gpuPods = pods.filter(pod => {
        let hasGPU = false;
        if (pod.spec && pod.spec.containers) {
            pod.spec.containers.forEach(container => {
                if (container.resources && container.resources.requests) {
                    if (container.resources.requests['nvidia.com/gpu'] || container.resources.requests.gpu) {
                        hasGPU = true;
                    }
                }
            });
        }
        return hasGPU;
    });
    
    const totalGPURequest = gpuPods.reduce((total, pod) => {
        if (pod.spec && pod.spec.containers) {
            pod.spec.containers.forEach(container => {
                if (container.resources && container.resources.requests) {
                    if (container.resources.requests['nvidia.com/gpu']) {
                        total += parseInt(container.resources.requests['nvidia.com/gpu']);
                    } else if (container.resources.requests.gpu) {
                        total += parseInt(container.resources.requests.gpu);
                    }
                }
            });
        }
        return total;
    }, 0);
    
    document.getElementById('totalGPUCount').textContent = totalGPURequest.toFixed(0);
    
    // Store pods with GPU for filtering
    window.gpuPodNames = gpuPods.map(pod => `${pod.metadata.namespace}/${pod.metadata.name}`);
    // Also store the full pod objects for use in the filter function
    window.podsWithGPUs = gpuPods;
    
    // Reset GPU filter text based on state
    if (window.gpuFilterActive) {
        document.getElementById('gpuFilterStatus').innerHTML = `<span class="badge bg-success"><i class="fas fa-filter"></i> Filtered</span>`;
        document.getElementById('clearGPUFilter').style.display = 'inline-block';
    } else {
        document.getElementById('gpuFilterStatus').textContent = 'Click to filter';
        document.getElementById('clearGPUFilter').style.display = 'none';
    }
}

// GPU Filter Functionality
function initializeGPUFilter() {
    console.log('Initializing GPU filter');
    window.gpuFilterActive = false;
    
    // Add event listener to GPU card for filtering
    const gpuCard = document.getElementById('gpuCard');
    const clearFilter = document.getElementById('clearGPUFilter');
    
    if (gpuCard) {
        gpuCard.addEventListener('click', function(e) {
            // Don't trigger if clicking on the clear button
            if (e.target.closest('#clearGPUFilter')) {
                return;
            }
            
            window.gpuFilterActive = !window.gpuFilterActive;
            
            // Apply the filter
            applyGPUFilter();
            
            // Update UI to show filter state
            gpuCard.classList.toggle('filter-active', window.gpuFilterActive);
            
            if (window.gpuFilterActive) {
                document.getElementById('gpuFilterStatus').innerHTML = `<span class="badge bg-success"><i class="fas fa-filter"></i> Filtered</span>`;
                clearFilter.style.display = 'inline-block';
            } else {
                document.getElementById('gpuFilterStatus').textContent = 'Click to filter';
                clearFilter.style.display = 'none';
            }
        });
    }
    
    if (clearFilter) {
        clearFilter.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent triggering the card click
            
            window.gpuFilterActive = false;
            
            // Clear the filter
            applyGPUFilter();
            
            // Update UI
            gpuCard.classList.remove('filter-active');
            document.getElementById('gpuFilterStatus').textContent = 'Click to filter';
            clearFilter.style.display = 'none';
        });
    }
}

function applyGPUFilter() {
    const activeTab = document.querySelector('#resourceTabs .nav-link.active');
    if (activeTab && activeTab.id === 'pods-tab') {
        filterResourceTable('pods');
    }
}

// Clear GPU filter directly (for use in the "Clear Filter" button)
function clearGPUFilter() {
    const gpuCard = document.getElementById('gpuCard');
    if (gpuCard) {
        window.gpuFilterActive = false;
        gpuCard.classList.remove('filter-active');
        
        // Update UI
        document.getElementById('gpuFilterStatus').textContent = 'Click to filter';
        document.getElementById('clearGPUFilter').style.display = 'none';
        
        // Clear filter in the table
        applyGPUFilter();
    }
}

// Initialize namespace functionality separately to ensure it works regardless of jQuery load order
function initializeNamespaceFunctionality() {
    console.log('Initializing namespace functionality');
    // Initialize namespaces tab
    $(document).ready(function() {
        // Initialize namespaces tab
        $('a[data-bs-toggle="tab"][data-bs-target="#namespaces"]').on('shown.bs.tab', function (e) {
            loadNamespaces();
        });

        // Refresh namespaces button
        $('#refreshNamespaces').on('click', function() {
            loadNamespaces();
        });

        // Filter namespaces
        $('#namespaceSearchInput').on('keyup', function() {
            filterNamespaces();
        });

        // Sort namespaces
        $('.sort-option').on('click', function(e) {
            e.preventDefault();
            const sortOption = $(this).data('sort');
            sortNamespaces(sortOption);
        });
    });
}

// Add call to initialize namespace functionality in the main initialization
document.addEventListener('DOMContentLoaded', function() {
    // Wait a short moment to ensure jQuery is fully loaded
    setTimeout(initializeNamespaceFunctionality, 500);
});

// Delete namespace confirmation input handling
$('#deleteNamespaceConfirm').on('input', function() {
    const typedName = $(this).val();
    const namespaceName = $('#namespaceModalName').text();
    
    if (typedName === namespaceName) {
        $('#deleteNamespaceButton').prop('disabled', false);
    } else {
        $('#deleteNamespaceButton').prop('disabled', true);
    }
});

// Delete namespace button handler
$('#deleteNamespaceButton').on('click', function() {
    const namespace = $('#namespaceModalName').text();
    const confirmInput = $('#deleteNamespaceConfirm').val();
    
    if (confirmInput !== namespace) {
        alert('The namespace name you entered does not match. Deletion canceled.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete the namespace "${namespace}" and ALL resources within it? This action cannot be undone.`)) {
        $.ajax({
            url: '/api/namespaces/' + namespace,
            method: 'DELETE',
            success: function(data) {
                $('#namespaceEditModal').modal('hide');
                showToast('success', 'Success', `Namespace "${namespace}" has been deleted.`);
                // Refresh namespaces list
                loadNamespaces();
            },
            error: function(xhr) {
                alert('Error deleting namespace: ' + 
                    (xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Unknown error'));
            }
        });
    }
});

// Edit namespace form submission handler
$('#editNamespaceForm').on('submit', function(e) {
    e.preventDefault();
    
    const namespace = $('#namespaceModalName').text();
    const labelsText = $('#editNamespaceLabels').val();
    
    // Parse labels from text input (format: key1=value1,key2=value2)
    const labels = {};
    if (labelsText) {
        labelsText.split(',').forEach(pair => {
            const [key, value] = pair.trim().split('=');
            if (key && value) {
                labels[key] = value;
            }
        });
    }
    
    $.ajax({
        url: '/api/namespaces/' + namespace,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ labels: labels }),
        success: function(data) {
            showToast('success', 'Success', `Namespace "${namespace}" has been updated.`);
            // Refresh namespaces list
            loadNamespaces();
        },
        error: function(xhr) {
            alert('Error updating namespace: ' + 
                (xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Unknown error'));
        }
    });
});

// Function to show toast notifications
function showToast(type, title, message) {
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : 
                   type === 'danger' ? 'bg-danger' : 
                   type === 'warning' ? 'bg-warning' : 'bg-info';
    
    const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${bgClass} text-white">
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    $('.toast-container').append(toastHTML);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 5000
    });
    
    toast.show();
    
    // Remove the toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        $(toastElement).remove();
    });
}
</script>
{% endblock %}
