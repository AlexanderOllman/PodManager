{% extends "base.html" %}

{% block title %}HPE Private Cloud AI Resource Manager{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Dashboard</h1>
    <p class="text-muted">Monitor and manage your Kubernetes resources</p>
</div>

<!-- Tab content container for all tabs -->
<div class="tab-content" id="mainTabContent">
    <!-- Dashboard Tab (Home) -->
    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
        <!-- Dashboard Metrics Cards -->
        <div class="dashboard-metrics">
            <div class="metric-card">
                <div class="metric-label">Total Pods</div>
                <div class="metric-value" id="pods-count">-</div>
                <div class="metric-description">Active pod instances</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Allocated vCPUs</div>
                <div class="metric-value" id="vcpu-count">-</div>
                <div class="metric-description">Total vCPU cores in use</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Allocated GPUs</div>
                <div class="metric-value" id="gpu-count">-</div>
                <div class="metric-description">Total GPUs assigned to pods</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Reserved</div>
                <div class="metric-value" id="reserved-metric">-</div>
                <div class="metric-description">Future metric</div>
            </div>
        </div>

        <!-- Resource Tabs -->
        <div class="resource-table-container">
            <div class="resource-table-header">
                <h2>Quick Find</h2>
                <div class="resource-table-actions">
                    <button class="table-action-button" id="refreshTableBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="table-action-button" id="expandTableBtn">
                        <i class="fas fa-expand-alt"></i> More
                    </button>
                </div>
                <div class="resource-table-search-container">
                    <div class="resource-table-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="resourceSearchInput" placeholder="Search resources...">
                    </div>
                </div>
                <div class="custom-tabs">
                    <button class="custom-tab active resource-tab" data-tab="pods">Pods</button>
                    <button class="custom-tab resource-tab" data-tab="services">Services</button>
                    <button class="custom-tab resource-tab" data-tab="inferenceservices">InferenceServices</button>
                    <button class="custom-tab resource-tab" data-tab="deployments">Deployments</button>
                    <button class="custom-tab resource-tab" data-tab="configmaps">ConfigMaps</button>
                    <button class="custom-tab resource-tab" data-tab="secrets">Secrets</button>
                </div>
            </div>

            <!-- Tab content for resource tabs -->
            <div class="resource-table-content">
                <div class="tab-content">
                    <!-- Pods Tab -->
                    <div class="tab-pane fade show active" id="pods" role="tabpanel">
                        <div class="loading-container" id="podsLoading">
                            <div class="spinner"></div>
                            <p>Loading pods...</p>
                        </div>
                        <table class="resource-table" id="podsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Ready</th>
                                <th>Status</th>
                                <th>Restarts</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>

                    <!-- Services Tab -->
                    <div class="tab-pane fade" id="services" role="tabpanel">
                <div class="loading-container" id="servicesLoading">
                    <div class="spinner"></div>
                            <p>Loading services...</p>
                </div>
                        <table class="resource-table" id="servicesTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Cluster-IP</th>
                                <th>External-IP</th>
                                <th>Ports</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>

                    <!-- InferenceServices Tab -->
                    <div class="tab-pane fade" id="inferenceservices" role="tabpanel">
                        <div class="loading-container" id="inferenceservicesLoading">
                    <div class="spinner"></div>
                            <p>Loading inference services...</p>
                </div>
                        <table class="resource-table" id="inferenceservicesTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Ready</th>
                                <th>Default Traffic</th>
                                <th>Canary Traffic</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>

                    <!-- Deployments Tab -->
                    <div class="tab-pane fade" id="deployments" role="tabpanel">
                <div class="loading-container" id="deploymentsLoading">
                    <div class="spinner"></div>
                            <p>Loading deployments...</p>
                </div>
                        <table class="resource-table" id="deploymentsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Ready</th>
                                <th>Up-to-date</th>
                                <th>Available</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>

                    <!-- ConfigMaps Tab -->
                    <div class="tab-pane fade" id="configmaps" role="tabpanel">
                <div class="loading-container" id="configmapsLoading">
                    <div class="spinner"></div>
                            <p>Loading config maps...</p>
                </div>
                        <table class="resource-table" id="configmapsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>

                    <!-- Secrets Tab -->
                    <div class="tab-pane fade" id="secrets" role="tabpanel">
                <div class="loading-container" id="secretsLoading">
                    <div class="spinner"></div>
                            <p>Loading secrets...</p>
                </div>
                        <table class="resource-table" id="secretsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Namespace</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table content will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- CLI Tab -->
    <div class="tab-pane fade" id="cli" role="tabpanel" aria-labelledby="cli-tab">
        <div class="terminal-container">
            <div id="terminal"></div>
            <div class="command-input">
                <input type="text" id="commandInput" class="form-control" placeholder="Enter command...">
                <button id="runCommand" class="btn btn-primary">Run</button>
        </div>
        </div>
    </div>
    
    <!-- YAML Tab -->
    <div class="tab-pane fade" id="yaml" role="tabpanel" aria-labelledby="yaml-tab">
        <div class="drop-zone" id="dropZone">
            <span class="drop-zone__prompt">Drop YAML file here or click to upload</span>
            <input type="file" name="yamlFile" class="drop-zone__input" id="yamlFileInput">
        </div>
        <div class="mt-3 text-center">
            <button id="uploadYaml" class="btn btn-primary" disabled>Apply YAML</button>
        </div>
        <div id="yamlResult" class="mt-3"></div>
    </div>
    
    <!-- Events Tab -->
    <div class="tab-pane fade" id="events" role="tabpanel" aria-labelledby="events-tab">
        <div class="form-group mb-3">
            <label for="namespaceSelect">Namespace:</label>
            <select id="namespaceSelect" class="form-control">
                <option value="all">All Namespaces</option>
            </select>
        </div>
        <div class="loading-container" id="eventsLoading">
            <div class="spinner"></div>
        </div>
        <div class="table-responsive">
            <table class="resource-table" id="eventsTable">
                <thead>
                    <tr>
                        <th>Namespace</th>
                        <th>Type</th>
                        <th>Reason</th>
                        <th>Object</th>
                        <th>Message</th>
                        <th>Age</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table content will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
        <div class="card">
            <div class="card-header">
                Application Settings
            </div>
            <div class="card-body">
                <h5 class="card-title">GitHub Integration</h5>
                <p class="card-text">Update the application from a GitHub repository:</p>
                <div class="mb-3">
                    <label for="githubRepoUrl" class="form-label">GitHub Repository URL:</label>
                    <input type="text" class="form-control" id="githubRepoUrl" value="{{ github_repo_url }}">
                </div>
                <button id="updateFromGithub" class="btn btn-primary" onclick="updateFromGithub()">Update from GitHub</button>
                <div id="githubResult" class="mt-3"></div>
                
                <hr>
                
                <h5 class="card-title">Application Control</h5>
                <p class="card-text">Manage the application:</p>
                <button id="refreshApp" class="btn btn-secondary me-2" onclick="refreshApplication()">Refresh Application</button>
                <button id="restartApp" class="btn btn-danger" onclick="restartApplication()">Restart Application</button>
                <div id="appControlResult" class="mt-3"></div>
                
                <!-- Refresh Log Display -->
                <div class="mt-4">
                    <h5 class="card-title">Operation Log</h5>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Refresh Log</span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearRefreshLog()">
                                <i class="fas fa-eraser"></i> Clear Log
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="refreshLog" class="bg-dark text-light p-3" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; border-radius: 0 0 0.25rem 0.25rem;">
                                <div class="text-muted">-- Log will appear here during refresh/restart operations --</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h5 class="card-title">About</h5>
                <p class="card-text">
                    HPE Private Cloud AI Resource Manager<br>
                    A Kubernetes resource management dashboard.
                </p>
                    </div>
                </div>
            </div>
        </div>
        
<!-- Fullscreen Mode Template - Hidden by default -->
<div id="fullscreenMode" style="display: none;" class="fullscreen-mode">
    <div class="fullscreen-header">
        <div class="fullscreen-title">Resource Explorer</div>
        <button class="fullscreen-close" id="closeFullscreenBtn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="fullscreenContent">
        <!-- Content will be cloned here when expanding -->
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
        // Initialize resource tabs
        document.querySelectorAll('.resource-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                switchTab(tabId);
            });
        });
        
        // Initialize the application features
        initializeApp();
        
        // Initial data load
        updateDashboardMetrics();
        loadResourceData('pods');
        
        // Initialize YAML upload
        setupDropZone();
        
        // Initialize namespaces for Events tab
        fetchNamespaces();
    });
    
    function initializeHomePage() {
        // Re-initialize dashboard elements when returning to home page
        updateDashboardMetrics();
        loadResourceData('pods');
        
        // Re-initialize resource controls
        initializeResourceControls();
    }
</script>
{% endblock %}