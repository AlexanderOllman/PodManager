{% extends "base.html" %}

{% block title %}Namespaces - HPE Private Cloud AI Resource Manager{% endblock %}

{% block content %}
<div class="header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Kubernetes Namespaces</h1>
            <a href="/" class="btn btn-outline-light" id="backButton">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="container mt-4">
    <!-- Filters and Controls -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-light border-0">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-0 bg-light" id="namespaceSearchInput" placeholder="Filter namespaces...">
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-sort me-1"></i> Sort By
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item sort-option" href="#" data-sort="name">Name (A-Z)</a></li>
                    <li><a class="dropdown-item sort-option" href="#" data-sort="name-desc">Name (Z-A)</a></li>
                    <li><a class="dropdown-item sort-option" href="#" data-sort="pods">Pods (High-Low)</a></li>
                    <li><a class="dropdown-item sort-option" href="#" data-sort="cpu">vCPU Usage (High-Low)</a></li>
                    <li><a class="dropdown-item sort-option" href="#" data-sort="gpu">GPU Usage (High-Low)</a></li>
                    <li><a class="dropdown-item sort-option" href="#" data-sort="memory">Memory Usage (High-Low)</a></li>
                </ul>
            </div>
            <button type="button" class="btn btn-primary ms-2" id="refreshNamespaces">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Namespaces Loading -->
    <div id="namespacesLoading" class="loading-container">
        <div class="progress-container">
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
            </div>
            <div class="loading-text">Loading namespaces...</div>
        </div>
    </div>

    <!-- Namespaces Table -->
    <div class="card shadow-sm mb-4" id="namespacesTableCard" style="display: none;">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="namespacesTable">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th class="text-center">Pods</th>
                        <th class="text-center">vCPU Usage</th>
                        <th class="text-center">GPU Usage</th>
                        <th class="text-center">Memory Usage</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="namespacesTableBody">
                    <!-- Table will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- No Results Message -->
    <div id="noNamespacesMessage" class="text-center py-5" style="display: none;">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h5>No namespaces found</h5>
        <p class="text-muted">Try adjusting your search or filter settings</p>
    </div>

    <!-- Namespace Edit Modal -->
    <div class="modal fade" id="namespaceEditModal" tabindex="-1" aria-labelledby="namespaceEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="namespaceEditModalLabel">Namespace: <span id="currentNamespaceName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="namespaceDetailTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-tab-content" type="button" role="tab">
                                Events
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="describe-tab" data-bs-toggle="tab" data-bs-target="#describe-tab-content" type="button" role="tab">
                                Describe
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit-tab-content" type="button" role="tab">
                                Edit
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="delete-tab" data-bs-toggle="tab" data-bs-target="#delete-tab-content" type="button" role="tab">
                                Delete
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content py-3" id="namespaceDetailTabContent">
                        <!-- Events Tab -->
                        <div class="tab-pane fade show active" id="events-tab-content" role="tabpanel">
                            <div id="namespaceEventsLoading" class="loading-container">
                                <div class="spinner"></div>
                            </div>
                            <pre id="namespaceEventsOutput" class="bg-light p-3 rounded" style="display: none;"></pre>
                        </div>
                        
                        <!-- Describe Tab -->
                        <div class="tab-pane fade" id="describe-tab-content" role="tabpanel">
                            <div id="namespaceDescribeLoading" class="loading-container">
                                <div class="spinner"></div>
                            </div>
                            <pre id="namespaceDescribeOutput" class="bg-light p-3 rounded" style="display: none;"></pre>
                        </div>
                        
                        <!-- Edit Tab -->
                        <div class="tab-pane fade" id="edit-tab-content" role="tabpanel">
                            <div id="namespaceEditLoading" class="loading-container">
                                <div class="spinner"></div>
                            </div>
                            <div id="namespaceEditContent" style="display: none;">
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Editing namespace configuration directly. Be careful with your changes.
                                </div>
                                <textarea id="namespaceYamlEditor" class="form-control code-editor" rows="20"></textarea>
                            </div>
                        </div>

                        <!-- Delete Tab -->
                        <div class="tab-pane fade" id="delete-tab-content" role="tabpanel">
                            <div class="alert alert-danger mb-4">
                                <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Warning: Dangerous Action</h4>
                                <p class="mb-0">Deleting a namespace will permanently remove <strong>ALL resources</strong> within it including:</p>
                                <ul class="mt-2">
                                    <li>All running pods and their data</li>
                                    <li>All services, deployments, and statefulsets</li>
                                    <li>All persistent volume claims and their data</li>
                                    <li>All configmaps and secrets</li>
                                </ul>
                                <p class="mt-2 mb-0"><strong>This action cannot be undone!</strong> Please ensure you fully understand the consequences before proceeding.</p>
                            </div>
                            
                            <div class="mb-4">
                                <label for="namespaceDeleteConfirm" class="form-label">To confirm deletion, type the namespace name "<span id="deleteNamespaceConfirmName"></span>":</label>
                                <input type="text" class="form-control" id="namespaceDeleteConfirm" placeholder="Type namespace name to confirm">
                            </div>
                            
                            <button type="button" class="btn btn-danger" id="confirmNamespaceDelete" disabled>
                                <i class="fas fa-trash-alt me-2"></i> Permanently Delete Namespace
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNamespaceChanges" style="display: none;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
// Initialize namespaces page
function initializeNamespacesPage() {
    console.log('Initializing namespaces page...');
    
    // Load namespaces immediately
    loadNamespaces();
    
    // Set up event handlers
    setupEventHandlers();
    
    // Back button handler
    document.getElementById('backButton').addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = '/';
    });
}

function setupEventHandlers() {
    // Refresh namespaces button
    document.getElementById('refreshNamespaces').addEventListener('click', function() {
        loadNamespaces();
    });

    // Filter namespaces
    document.getElementById('namespaceSearchInput').addEventListener('keyup', function() {
        filterNamespaces();
    });

    // Sort namespaces
    document.querySelectorAll('.sort-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const sortBy = this.getAttribute('data-sort');
            sortNamespaces(sortBy);
        });
    });

    // Handle namespace actions
    document.addEventListener('click', function(e) {
        const target = e.target.closest('.namespace-action');
        if (target) {
            const action = target.getAttribute('data-action');
            const namespace = target.getAttribute('data-namespace');
            
            if (action === 'events') {
                openNamespaceModal(namespace, 'events');
            } else if (action === 'describe') {
                openNamespaceModal(namespace, 'describe');
            } else if (action === 'edit') {
                openNamespaceModal(namespace, 'edit');
            } else if (action === 'delete') {
                openNamespaceModal(namespace, 'delete');
            }
        }
    });

    // Save namespace changes
    document.getElementById('saveNamespaceChanges').addEventListener('click', function() {
        saveNamespaceChanges();
    });

    // Handle namespace delete confirmation input
    document.getElementById('namespaceDeleteConfirm').addEventListener('input', function() {
        const inputValue = this.value;
        const namespaceName = document.getElementById('currentNamespaceName').textContent;
        
        if (inputValue === namespaceName) {
            document.getElementById('confirmNamespaceDelete').disabled = false;
        } else {
            document.getElementById('confirmNamespaceDelete').disabled = true;
        }
    });
    
    // Handle namespace delete button
    document.getElementById('confirmNamespaceDelete').addEventListener('click', function() {
        deleteNamespace();
    });

    // Switch tabs in namespace modal
    document.querySelectorAll('#namespaceDetailTabs button').forEach(button => {
        button.addEventListener('shown.bs.tab', function() {
            const tabId = this.id;
            if (tabId === 'edit-tab') {
                document.getElementById('saveNamespaceChanges').style.display = 'block';
            } else {
                document.getElementById('saveNamespaceChanges').style.display = 'none';
            }
        });
    });
}

// Load namespaces data
function loadNamespaces() {
    // Show loading indicator
    document.getElementById('namespacesLoading').style.display = 'flex';
    document.getElementById('namespacesTableCard').style.display = 'none';
    document.getElementById('noNamespacesMessage').style.display = 'none';
    
    fetch('/get_namespace_details')
        .then(response => response.json())
        .then(data => {
            // Store data for later use
            window.namespacesData = data.namespaces;
            
            // Render the namespaces
            renderNamespaces(data.namespaces);
            
            // Hide loading indicator
            document.getElementById('namespacesLoading').style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading namespaces:', error);
            document.getElementById('namespacesLoading').style.display = 'none';
            document.getElementById('noNamespacesMessage').style.display = 'block';
            document.querySelector('#noNamespacesMessage h5').textContent = 'Error loading namespaces';
        });
}

// Filter namespaces based on search input
function filterNamespaces() {
    const searchTerm = document.getElementById('namespaceSearchInput').value.toLowerCase();
    
    if (!window.namespacesData) return;
    
    const filteredNamespaces = window.namespacesData.filter(ns => 
        ns.name.toLowerCase().includes(searchTerm)
    );
    
    renderNamespaces(filteredNamespaces);
}

// Render namespaces to the table
function renderNamespaces(namespaces) {
    const tableBody = document.getElementById('namespacesTableBody');
    tableBody.innerHTML = '';

    if (namespaces.length === 0) {
        document.getElementById('namespacesTableCard').style.display = 'none';
        document.getElementById('noNamespacesMessage').style.display = 'block';
        return;
    }

    document.getElementById('namespacesTableCard').style.display = 'block';
    document.getElementById('noNamespacesMessage').style.display = 'none';

    namespaces.forEach(function(ns) {
        const row = document.createElement('tr');
        
        // Name column
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-sm rounded bg-info me-3">
                        <span class="avatar-title rounded">
                            <i class="fas fa-project-diagram text-white"></i>
                        </span>
                    </div>
                    <div>
                        <h6 class="mb-0">${ns.name}</h6>
                        <small class="text-muted">${getCreationTime(ns)}</small>
                    </div>
                </div>
            </td>
            <td class="text-center">
                <span class="fw-bold">${ns.podCount}</span>
            </td>
            <td class="text-center resource-cell cpu-cell">
                <span class="fw-bold">${ns.resources.cpu}</span> vCPUs
            </td>
            <td class="text-center resource-cell gpu-cell">
                <span class="fw-bold">${ns.resources.gpu}</span> GPUs
            </td>
            <td class="text-center resource-cell memory-cell">
                <span class="fw-bold">${ns.resources.memory}</span> MB
            </td>
            <td class="text-center">
                <span class="badge bg-${getNamespaceStatus(ns).color}">${getNamespaceStatus(ns).text}</span>
            </td>
            <td class="text-center">
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary namespace-action" data-action="events" data-namespace="${ns.name}">
                        <i class="fas fa-list-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary namespace-action" data-action="describe" data-namespace="${ns.name}">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary namespace-action" data-action="edit" data-namespace="${ns.name}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger namespace-action" data-action="delete" data-namespace="${ns.name}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

// Sort namespaces
function sortNamespaces(sortBy) {
    if (!window.namespacesData) return;
    
    const sortedNamespaces = [...window.namespacesData];
    
    switch (sortBy) {
        case 'name':
            sortedNamespaces.sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'name-desc':
            sortedNamespaces.sort((a, b) => b.name.localeCompare(a.name));
            break;
        case 'pods':
            sortedNamespaces.sort((a, b) => b.podCount - a.podCount);
            break;
        case 'cpu':
            sortedNamespaces.sort((a, b) => b.resources.cpu - a.resources.cpu);
            break;
        case 'gpu':
            sortedNamespaces.sort((a, b) => b.resources.gpu - a.resources.gpu);
            break;
        case 'memory':
            sortedNamespaces.sort((a, b) => b.resources.memory - a.resources.memory);
            break;
        default:
            break;
    }
    
    renderNamespaces(sortedNamespaces);
}

// Get namespace creation time
function getCreationTime(namespace) {
    if (namespace.metadata && namespace.metadata.creationTimestamp) {
        const date = new Date(namespace.metadata.creationTimestamp);
        return `Created ${date.toLocaleDateString()}`;
    }
    return '';
}

// Get namespace status
function getNamespaceStatus(namespace) {
    // Check for the Active status in status.phase
    if (namespace.metadata && namespace.metadata.status && namespace.metadata.status.phase === 'Active') {
        return { text: 'Active', color: 'success' };
    }
    
    // For namespaces with pods, consider them active
    if (namespace.podCount > 0) {
        return { text: 'Active', color: 'success' };
    }
    
    // Check if it's a system namespace
    const systemNamespaces = ['kube-system', 'kube-public', 'kube-node-lease', 'default'];
    if (systemNamespaces.includes(namespace.name)) {
        return { text: 'System', color: 'info' };
    }
    
    // Default for empty namespaces
    return { text: 'Inactive', color: 'secondary' };
}

// Open the namespace modal
function openNamespaceModal(namespace, tab) {
    // Set the current namespace name
    document.getElementById('currentNamespaceName').textContent = namespace;
    document.getElementById('deleteNamespaceConfirmName').textContent = namespace;
    
    // Reset delete confirmation
    document.getElementById('namespaceDeleteConfirm').value = '';
    document.getElementById('confirmNamespaceDelete').disabled = true;
    
    // Get the modal and activate it
    const modal = new bootstrap.Modal(document.getElementById('namespaceEditModal'));
    modal.show();
    
    // Activate the appropriate tab
    const tabElement = document.getElementById(`${tab}-tab`);
    if (tabElement) {
        const tabInstance = new bootstrap.Tab(tabElement);
        tabInstance.show();
        
        // Show/hide save button for edit tab
        if (tab === 'edit') {
            document.getElementById('saveNamespaceChanges').style.display = 'block';
        } else {
            document.getElementById('saveNamespaceChanges').style.display = 'none';
        }
    }
    
    // Load content based on tab
    if (tab === 'events') {
        loadNamespaceEvents(namespace);
    } else if (tab === 'describe') {
        loadNamespaceDescription(namespace);
    } else if (tab === 'edit') {
        loadNamespaceYaml(namespace);
    }
}

// Load namespace events
function loadNamespaceEvents(namespace) {
    document.getElementById('namespaceEventsLoading').style.display = 'flex';
    document.getElementById('namespaceEventsOutput').style.display = 'none';
    
    fetch('/api/namespace/events', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('namespaceEventsOutput').textContent = data.output;
        document.getElementById('namespaceEventsLoading').style.display = 'none';
        document.getElementById('namespaceEventsOutput').style.display = 'block';
    })
    .catch(error => {
        console.error('Error loading events:', error);
        document.getElementById('namespaceEventsOutput').textContent = `Error loading events: ${error.message}`;
        document.getElementById('namespaceEventsLoading').style.display = 'none';
        document.getElementById('namespaceEventsOutput').style.display = 'block';
    });
}

// Load namespace description
function loadNamespaceDescription(namespace) {
    document.getElementById('namespaceDescribeLoading').style.display = 'flex';
    document.getElementById('namespaceDescribeOutput').style.display = 'none';
    
    fetch('/api/namespace/describe', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('namespaceDescribeOutput').textContent = data.output;
        document.getElementById('namespaceDescribeLoading').style.display = 'none';
        document.getElementById('namespaceDescribeOutput').style.display = 'block';
    })
    .catch(error => {
        console.error('Error loading description:', error);
        document.getElementById('namespaceDescribeOutput').textContent = `Error loading description: ${error.message}`;
        document.getElementById('namespaceDescribeLoading').style.display = 'none';
        document.getElementById('namespaceDescribeOutput').style.display = 'block';
    });
}

// Load namespace YAML for editing
function loadNamespaceYaml(namespace) {
    document.getElementById('namespaceEditLoading').style.display = 'flex';
    document.getElementById('namespaceEditContent').style.display = 'none';
    
    fetch('/api/namespace/edit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('namespaceYamlEditor').value = data.yaml;
        document.getElementById('namespaceEditLoading').style.display = 'none';
        document.getElementById('namespaceEditContent').style.display = 'block';
    })
    .catch(error => {
        console.error('Error loading YAML:', error);
        document.getElementById('namespaceYamlEditor').value = `Error loading YAML: ${error.message}`;
        document.getElementById('namespaceEditLoading').style.display = 'none';
        document.getElementById('namespaceEditContent').style.display = 'block';
    });
}

// Save namespace changes
function saveNamespaceChanges() {
    const namespace = document.getElementById('currentNamespaceName').textContent;
    const yaml = document.getElementById('namespaceYamlEditor').value;
    
    // Show saving indicator
    document.getElementById('namespaceEditLoading').style.display = 'flex';
    document.getElementById('namespaceEditContent').style.display = 'none';
    
    fetch('/api/namespace/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}&yaml=${encodeURIComponent(yaml)}`
    })
    .then(response => response.json())
    .then(data => {
        // Show result
        document.getElementById('namespaceYamlEditor').value = yaml + '\n\n# Result: ' + data.output;
        document.getElementById('namespaceEditLoading').style.display = 'none';
        document.getElementById('namespaceEditContent').style.display = 'block';
        
        // Refresh namespaces list
        loadNamespaces();
    })
    .catch(error => {
        console.error('Error saving changes:', error);
        document.getElementById('namespaceYamlEditor').value = yaml + '\n\n# Error: ' + error.message;
        document.getElementById('namespaceEditLoading').style.display = 'none';
        document.getElementById('namespaceEditContent').style.display = 'block';
    });
}

// Delete namespace
function deleteNamespace() {
    const namespace = document.getElementById('currentNamespaceName').textContent;
    
    // Disable the button to prevent multiple clicks
    document.getElementById('confirmNamespaceDelete').disabled = true;
    document.getElementById('confirmNamespaceDelete').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Deleting...';
    
    fetch('/api/namespace/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}`
    })
    .then(response => response.json())
    .then(data => {
        // Close the modal
        const modalElement = document.getElementById('namespaceEditModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();
        
        // Refresh namespaces list
        loadNamespaces();
        
        // Show success message
        alert(`Namespace ${namespace} deleted successfully.`);
    })
    .catch(error => {
        console.error('Error deleting namespace:', error);
        document.getElementById('confirmNamespaceDelete').disabled = false;
        document.getElementById('confirmNamespaceDelete').innerHTML = '<i class="fas fa-trash-alt me-2"></i> Permanently Delete Namespace';
        alert(`Error deleting namespace: ${error.message}`);
    });
}

// Initialize the page when the DOM is loaded
document.addEventListener('DOMContentLoaded', initializeNamespacesPage);
</script>
{% endblock %} 