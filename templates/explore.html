{% extends "base.html" %}

{% block title %}Explore Pod: {{ pod_name }}{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Pod: {{ pod_name }}</h1>
            <p class="text-muted mb-0">Namespace: {{ namespace }}</p>
        </div>
        <a href="/" class="btn btn-outline-secondary" id="backButton">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </a>
    </div>

    <!-- Pod Details Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-transparent py-3">
            <ul class="nav nav-tabs card-header-tabs" id="podTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="describe-tab" data-bs-toggle="tab" data-bs-target="#describe" type="button" role="tab" aria-controls="describe" aria-selected="true">
                        <i class="fas fa-info-circle me-1"></i> Describe
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">
                        <i class="fas fa-file-alt me-1"></i> Logs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="access-tab" data-bs-toggle="tab" data-bs-target="#access" type="button" role="tab" aria-controls="access" aria-selected="false">
                        <i class="fas fa-terminal me-1"></i> Access
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body">
            <div class="tab-content" id="podTabsContent">
                <div class="tab-pane fade show active" id="describe" role="tabpanel" aria-labelledby="describe-tab">
                    <div id="describeLoading" class="loading-container">
                        <div class="spinner"></div>
                    </div>
                    <pre id="describeOutput" style="display: none;"></pre>
                </div>
                <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
                    <div id="logsLoading" class="loading-container">
                        <div class="spinner"></div>
                    </div>
                    <pre id="logsOutput" style="display: none;"></pre>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="refreshLogs">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                        <button class="btn btn-outline-secondary ms-2" id="downloadLogs">
                            <i class="fas fa-download me-1"></i> Download
                        </button>
                    </div>
                </div>
                <div class="tab-pane fade" id="access" role="tabpanel" aria-labelledby="access-tab">
                    <div class="alert alert-info mb-3">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-info-circle fa-2x"></i>
                            </div>
                            <div>
                                <h5 class="alert-heading">Interactive Pod Terminal</h5>
                                <p class="mb-2">You can now type commands directly in the terminal below. Press Enter to execute.</p>
                                <ul class="mb-0">
                                    <li>Commands are executed in the pod's environment</li>
                                    <li>Use <kbd>Up</kbd> and <kbd>Down</kbd> arrow keys to navigate through command history</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="terminal-container">
                        <div id="terminal"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
// Store the namespace and pod name in JavaScript variables
const namespace = "{{ namespace }}";
const podName = "{{ pod_name }}";

function initializeExplorePage() {
    console.log(`Initializing explore page for pod: ${podName} in namespace: ${namespace}`);
    
    // Load the pod description immediately
    loadPodDescription();
    
    // Set up tab handlers
    document.getElementById('logs-tab').addEventListener('click', loadPodLogs);
    document.getElementById('access-tab').addEventListener('click', setupTerminal);
    
    // Set up button handlers
    document.getElementById('refreshLogs').addEventListener('click', loadPodLogs);
    document.getElementById('downloadLogs').addEventListener('click', downloadLogs);
    
    // Back button handler that uses SPA navigation
    document.getElementById('backButton').addEventListener('click', function(e) {
        e.preventDefault();
        console.log("Returning to home page");
        window.location.href = '/'; // Use direct navigation instead of SPA
    });
}

// Function to load pod description
function loadPodDescription() {
    const describeLoading = document.getElementById('describeLoading');
    const describeOutput = document.getElementById('describeOutput');
    
    describeLoading.style.display = 'flex';
    describeOutput.style.display = 'none';
    
    fetch('/api/pod/describe', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}&pod_name=${podName}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.output) {
            describeOutput.textContent = data.output;
            describeOutput.style.display = 'block';
        } else if (data.error) {
            describeOutput.textContent = `Error: ${data.error}`;
            describeOutput.style.display = 'block';
        }
        describeLoading.style.display = 'none';
    })
    .catch(error => {
        console.error('Error:', error);
        describeOutput.textContent = 'An error occurred while fetching pod description.';
        describeOutput.style.display = 'block';
        describeLoading.style.display = 'none';
    });
}

// Function to load pod logs
function loadPodLogs() {
    const logsLoading = document.getElementById('logsLoading');
    const logsOutput = document.getElementById('logsOutput');
    
    logsLoading.style.display = 'flex';
    logsOutput.style.display = 'none';
    
    fetch('/api/pod/logs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `namespace=${namespace}&pod_name=${podName}&tail_lines=1000`
    })
    .then(response => response.json())
    .then(data => {
        if (data.output) {
            logsOutput.textContent = data.output;
            logsOutput.style.display = 'block';
        } else if (data.error) {
            logsOutput.textContent = `Error: ${data.error}`;
            logsOutput.style.display = 'block';
        }
        logsLoading.style.display = 'none';
    })
    .catch(error => {
        console.error('Error:', error);
        logsOutput.textContent = 'An error occurred while fetching pod logs.';
        logsOutput.style.display = 'block';
        logsLoading.style.display = 'none';
    });
}

// Function to download logs
function downloadLogs() {
    const logs = document.getElementById('logsOutput').textContent;
    const blob = new Blob([logs], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${podName}_logs.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Function to set up terminal
function setupTerminal() {
    // Only set up the terminal if it hasn't been initialized yet
    if (!window.app.terminal) {
        try {
            console.log('Setting up terminal...');
            
            // Create a new terminal
            window.app.terminal = new Terminal({
                cursorBlink: true,
                scrollback: 1000,
                cols: 100,
                rows: 30
            });
            
            // Open the terminal in the container
            window.app.terminal.open(document.getElementById('terminal'));
            
            // Set up socket connection for terminal
            if (window.app.socket) {
                window.app.socket.on('output', function(data) {
                    window.app.terminal.write(data.data);
                });
                
                // Set up input handling
                window.app.terminal.onData(function(data) {
                    window.app.socket.emit('input', { data: data });
                });
                
                // Request shell access
                window.app.socket.emit('shell', { namespace: namespace, pod_name: podName });
                
                console.log('Terminal ready');
            } else {
                console.error('Socket.IO not available');
                window.app.terminal.write('Error: Socket.IO connection not available\r\n');
            }
        } catch (err) {
            console.error('Terminal setup error:', err);
            const terminal = document.getElementById('terminal');
            terminal.innerHTML = `<div class="alert alert-danger">Failed to initialize terminal: ${err.message}</div>`;
        }
    }
}

// Initialize the page when it loads
initializeExplorePage();
</script>
{% endblock %} 